(function(){function h(e){const o=e.getAttribute("field_type");let t=!0,i=window.geodir_params?.field_id_required||"This field is required.";const n=e.closest(".required_field");if(!n)return!0;switch(o){case"radio":case"checkbox":const r=n.querySelectorAll(":checked");t=r.length>0;const s=n.querySelector("#cat_limit");if(s){const u=parseInt(s.getAttribute("cat_limit")),g=s.value;r.length>u&&u>0&&(t=!1,i=g)}break;case"select":if(n.querySelector(".geodir_taxonomy_field")&&n.querySelector("#post_category"))t=n.querySelector("#post_category").value!=="";else{const u=e.querySelector("option:selected");t=u&&u.value!==""}break;case"multiselect":const a=n.querySelector("#cat_limit");if(a){const u=parseInt(a.getAttribute("cat_limit")),g=a.value,p=e.querySelectorAll("option:selected");p.length>u&&u>0?(t=!1,i=g):t=p.length>0}else t=e.querySelectorAll("option:selected").length>0;break;case"email":const l=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;t=e.value!==""&&l.test(e.value);break;case"url":const c=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;t=e.value!==""&&c.test(e.value);break;case"editor":const f=e.getAttribute("field_id"),d=document.getElementById(f);t=d&&d.value!=="";break;case"address":e.id==="post_latitude"||e.id==="post_longitude"?/^[0-90\-.]*$/.test(e.value)&&e.value!==""?t=!0:(t=!1,i=e.id==="post_latitude"?window.geodir_params?.latitude_error_msg||"Please enter a valid latitude.":window.geodir_params?.longgitude_error_msg||"Please enter a valid longitude."):t=e.value.trim()!=="";break;case"datepicker":case"time":case"text":case"hidden":case"textarea":t=e.value.trim()!=="";break;default:t=e.value.trim()!=="";break}return x(n,e,t,i),t}function x(e,o,t,i){const n=e.querySelector(".geodir_message_error");t?(o.classList.remove("is-invalid"),o.classList.add("is-valid"),n&&(n.textContent="",n.style.display="none")):(o.classList.remove("is-valid"),o.classList.add("is-invalid"),n&&(n.textContent===""&&(n.textContent=i),n.style.display="block"))}function _(e){let o=!0;return e.querySelectorAll('.required_field:not([style*="display: none"])').forEach(i=>{i.querySelectorAll('[field_type]:not([style*="display: none"]), .geodir_select, .geodir_location_add_listing_chosen, .editor, .event_recurring_dates, .geodir-custom-file-upload, .gd_image_required_field, .g-recaptcha-response, [name="cf-turnstile-response"]').forEach(r=>{h(r)||(o=!1)})}),o}function k(e){let o=!0;if(e.querySelectorAll('.required_field:not([style*="display: none"])').forEach(i=>{i.querySelectorAll('[field_type]:not([style*="display: none"]), .geodir_select, .geodir_location_add_listing_chosen, .editor, .event_recurring_dates, .geodir-custom-file-upload, .gd_image_required_field').forEach(r=>{h(r)||(o=!1)})}),!o){const i=document.querySelector("#save-action .spinner"),n=document.querySelector("#save-action #save-post"),r=document.querySelector("#publishing-action .spinner"),s=document.querySelector("#publishing-action #publish");i&&i.classList.remove("is-active"),n&&n.classList.remove("disabled"),r&&r.classList.remove("is-active"),s&&s.classList.remove("disabled")}return o}function I(){typeof tinymce<"u"&&tinymce.editors&&tinymce.editors.length>0&&tinymce.editors.forEach(e=>{e.save()})}function w(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}function m(e){I();const o=new FormData(e);return new URLSearchParams(o).toString()}function D(e,o=100){if(!e)return;const i=e.getBoundingClientRect().top+window.pageYOffset-o;window.scrollTo({top:i,behavior:"smooth"})}let q=!1,y=!1,S="";function z(e){const o=window.geodir_params?.autosave||0;o<=0||(S=m(e),B(e),R(e,o),$())}function B(e){if(!w())return;const o=e.querySelector("#user_login"),t=e.querySelector("#user_email");o&&localStorage.getItem("geodirUserLogin")&&(o.value=localStorage.getItem("geodirUserLogin")),t&&localStorage.getItem("geodirUserEmail")&&(t.value=localStorage.getItem("geodirUserEmail"))}function H(e){if(!w())return;const o=e.querySelector("#user_login"),t=e.querySelector("#user_email");o&&o.value&&localStorage.setItem("geodirUserLogin",o.value),t&&t.value&&localStorage.setItem("geodirUserEmail",t.value)}function M(){w()&&(localStorage.removeItem("geodirUserLogin"),localStorage.removeItem("geodirUserEmail"))}function R(e,o){setInterval(()=>{const t=m(e);t!==S&&!y&&(console.log("Form has changed, auto-saving..."),A(e),q=!0,S=t)},o)}async function A(e){if(y)return;H(e);const t=m(e)+"&action=geodir_auto_save_post&target=auto";try{(await(await fetch(window.geodir_params.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t})).json()).success?console.log("Auto-saved successfully"):console.log("Auto-save failed")}catch(i){console.error("Auto-save error:",i)}}function O(e){return A(e)}function $(){window.addEventListener("beforeunload",e=>{if(q){const o=window.geodir_params?.txt_lose_changes||"You have unsaved changes. Are you sure you want to leave?";return e.preventDefault(),e.returnValue=o,o}})}function V(){q=!1}typeof window<"u"&&(window.geodirUploading=!1,Object.defineProperty(window,"geodirUploading",{get(){return y},set(e){y=e}}));async function U(e,o){return e.preventDefault(),_(o)?(await P(o),!1):(j(o),!1)}async function P(e){const o=m(e)+"&target=submit";console.log("Submitting form...");const t=e.querySelector("#geodir-add-listing-submit button"),i=t?t.innerHTML:"";try{t&&(t.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> '+i,t.classList.add("gd-disabled"),t.disabled=!0),M();const r=await(await fetch(window.geodir_params.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o})).json();if(r.success){console.log("Form submitted successfully"),console.log(r.data),V(),document.querySelectorAll(".gd-notification").forEach(c=>c.remove());const s=document.querySelector("#gd-add-listing-replace-container"),a=s?s.value:"#geodirectory-add-post",l=document.querySelector(a);if(l&&r.data){l.outerHTML=r.data;const c=document.querySelector(".gd-notification");if(c){const f=c.getBoundingClientRect().top+window.pageYOffset-100;window.scrollTo({top:f,behavior:"smooth"})}}return!0}else return console.log("Form submission failed"),t&&(t.innerHTML=i,t.classList.remove("gd-disabled"),t.disabled=!1),r.data&&alert(r.data),document.dispatchEvent(new Event("ayecode_reset_captcha")),!1}catch(n){console.error("Form submission error:",n),t&&(t.innerHTML=i,t.classList.remove("gd-disabled"),t.disabled=!1);const r=window.geodir_params?.rating_error_msg||"An error occurred. Please try again.";return alert(r),document.dispatchEvent(new Event("ayecode_reset_captcha")),!1}}async function G(e){const t=m(e)+"&action=geodir_delete_revision&target=revision";try{const n=await(await fetch(window.geodir_params.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t})).json();return n.success?(console.log("Revision deleted successfully"),location.reload(),!0):(console.log("Revision deletion failed"),n.data&&alert(n.data),!1)}catch(i){return console.error("Revision deletion error:",i),!1}}function j(e){const o=e.querySelector('.geodir_message_error:not([style*="display: none"])');if(o){const i=o.closest(".required_field");if(i){const n=i.getBoundingClientRect().top+window.pageYOffset;window.scrollTo({top:n,behavior:"smooth"});return}}const t=e.querySelector(".is-invalid");if(t){const i=t.getBoundingClientRect().top+window.pageYOffset;window.scrollTo({top:i,behavior:"smooth"})}}function L(e){N(e),Y(e),Q(e),T(e)}function N(e){e.querySelectorAll(".geodir_form_row input[data-ccheckbox]").forEach(n=>{n.addEventListener("change",function(r){Z(this,e)})}),e.querySelectorAll(".gd-make-default-term").forEach(n=>{n.addEventListener("click",function(r){r.preventDefault(),W(this,e)})});const i=e.querySelector(".geodir_form_row input[data-ccheckbox]:first-of-type");i&&i.dispatchEvent(new Event("change"))}function Z(e,o){const t=e.closest(".geodir_form_row"),i=e.dataset.ccheckbox,n=o.querySelector(`input[name="${i}"]`);if(!t||!n)return;t.classList.remove("gd-term-handle"),t.querySelectorAll(".gd-term-checked").forEach(d=>d.classList.remove("gd-term-checked")),t.querySelectorAll(".gd-default-term").forEach(d=>d.classList.remove("gd-default-term"));let r=0,s=null;const a=n.value||"",l=e.getAttribute("name");t.querySelectorAll(`[name="${l}"]`).forEach(d=>{d.checked&&(r++,d.parentElement.classList.add("gd-term-checked"),r===1&&(s=d))}),r>1&&t.classList.add("gd-term-handle");const f=t.querySelector(`#gd-cat-${a}`);if(f&&f.checked&&(s=f),s){const d=s.parentElement.querySelector(".gd-make-default-term");d&&d.click()}else n.value="",n.dispatchEvent(new Event("change"))}function W(e,o){const t=e.closest(".geodir_form_row"),i=e.parentElement,n=i.querySelector('[type="checkbox"]');if(!n)return;const r=n.dataset.ccheckbox,s=o.querySelector(`input[name="${r}"]`);if(!s)return;t.querySelectorAll(".gd-default-term").forEach(l=>l.classList.remove("gd-default-term")),i.classList.add("gd-default-term");const a=n.value;s.value=a,s.dispatchEvent(new Event("change"))}function Y(e){e.querySelectorAll(".geodir_form_row input[data-cradio]").forEach(i=>{i.addEventListener("change",function(){J(this,e)})});const t=e.querySelector(".geodir_form_row input[data-cradio]:first-of-type");t&&t.dispatchEvent(new Event("change"))}function J(e,o){const t=e.dataset.cradio,i=o.querySelector(`input[name="${t}"]`);if(!i)return;let n="";const r=e.getAttribute("name"),s=o.querySelector(`[name="${r}"]:checked`);s&&(n=s.value),i.value=n}function Q(e){e.querySelectorAll('.geodir_taxonomy_field .geodir-category-select, .geodir_taxonomy_field [data-ccheckbox="default_category"], .geodir_taxonomy_field input[data-cradio]').forEach(t=>{t.addEventListener("change",()=>{T(e);const i=e.querySelector('[name="default_category"]');i&&i.dispatchEvent(new Event("change"))})})}function T(e){const o=e.querySelector("#default_category");if(!o)return;const t=o.value,i=e.querySelector(".geodir_taxonomy_field .geodir-category-select");if(i){o.innerHTML="";const s=Array.from(i.selectedOptions).map(a=>a.value);s.length>0?i.querySelectorAll("option").forEach(a=>{if(s.includes(a.value)){const l=document.createElement("option");l.value=a.value,l.textContent=a.textContent,l.selected=t===a.value||!t&&s[0]===a.value,o.appendChild(l)}}):o.value="";return}const n=e.querySelectorAll('.geodir_taxonomy_field [data-ccheckbox="default_category"]');if(n.length>0){o.innerHTML="";const s=Array.from(n).filter(a=>a.checked);s.length>0?s.forEach((a,l)=>{const c=document.createElement("option");c.value=a.value,c.textContent=a.title||a.value,c.selected=t===a.value||!t&&l===0,o.appendChild(c)}):o.value="";return}if(e.querySelectorAll('.geodir_taxonomy_field [data-cradio="default_category"]').length>0){const s=e.querySelector('.geodir_taxonomy_field [data-cradio="default_category"]:checked');s?o.value=s.value:o.value=""}}class K{constructor(o){if(this.params=o,this.field=o.field,this.fieldElement=document.querySelector(`[name="${this.field}"]`),!this.fieldElement||(this.wrap=this.fieldElement.closest(".gd-bh-row"),!this.wrap))return;const t=this.wrap.querySelector(".gd-bh-items .gd-bh-blank");this.slotTemplate=t?t.innerHTML:"",this.defaultTimezoneString=window.geodir_params?.timezone_string||"",this.defaultOffset=window.geodir_params?.gmt_offset||"0",this.gmtOffset=o.offset||this.defaultOffset,this.init()}init(){this.setupActiveToggle(),this.setupTimezoneChange(),this.setupAddSlot(),this.setup24HoursToggle(),setTimeout(()=>{this.initializeExistingSlots(),this.attachRemoveHandlers(),this.attachChangeHandlers()},100)}setupActiveToggle(){const o=this.wrap.querySelector('[data-field="active"]');o&&o.addEventListener("change",t=>{const i=this.wrap.querySelector(".gd-bh-items");if(o.value==="1"){i&&(i.style.display="block");const n=this.wrap.querySelector('[data-field="timezone_string"]');n&&n.classList.contains("select2-hidden-accessible")}else i&&(i.style.display="none");this.setValue(),t.preventDefault()})}setupTimezoneChange(){const o=this.wrap.querySelector('[data-field="timezone_string"]');if(!o)return;o.addEventListener("change",i=>{this.setValue(),i.preventDefault()});const t=this.wrap.closest("form");if(t){const i=t.querySelector('[name="latitude"]'),n=t.querySelector('[name="longitude"]');i&&n&&[i,n].forEach(r=>{r.addEventListener("change",()=>{window.gdTzApi||(window.gdTzApi=!0,setTimeout(()=>{this.getTimezone(o)},1e3))})})}}setupAddSlot(){this.wrap.querySelectorAll(".gd-bh-add").forEach(t=>{t.addEventListener("click",i=>{i.preventDefault(),this.addSlot(t)})})}setup24HoursToggle(){this.wrap.querySelectorAll('.gd-bh-24hours [type="checkbox"]').forEach(t=>{t.addEventListener("click",()=>{this.handle24HoursChange(t)})})}initializeExistingSlots(){this.wrap.querySelectorAll(".gd-bh-has24").forEach(i=>{this.handle24Hours(i.closest(".gd-bh-item"))}),this.wrap.querySelectorAll(".gd-bh-hours").length>0&&this.attachChangeHandlers()}addSlot(o){const t=o.closest(".gd-bh-item");if(!t)return;const i=Math.floor(Math.random()*1e11).toString();t.querySelectorAll(".gd-bh-closed").forEach(l=>l.remove()),t.classList.remove("gd-bh-item-closed");const n=t.querySelector('.gd-bh-24hours [type="checkbox"]');n&&(n.style.display="");let r=this.slotTemplate.replace(/GD_UNIQUE_ID/g,i);const s=t.querySelector(".gd-bh-time");if(!s)return;const a=s.dataset.field;r=r.replace('data-field-alt="open"',`data-field-alt="open" name="${a}[open][]" data-aui-init="flatpickr"`),r=r.replace('data-field-alt="close"',`data-field-alt="close" name="${a}[close][]" data-aui-init="flatpickr"`),s.insertAdjacentHTML("beforeend",r),this.initTimePickers(),this.attachRemoveHandlers(),this.attachChangeHandlers()}removeSlot(o){const t=o.closest(".gd-bh-hours");if(!t)return;const i=t.closest(".gd-bh-time"),n=i.closest(".gd-bh-item");if(t.remove(),i.querySelectorAll(".gd-bh-hours").length===0){n.classList.add("gd-bh-item-closed");const s=n.querySelector('.gd-bh-24hours [type="checkbox"]');s&&(s.style.display="none");const a=window.geodir_params?.txt_closed||"Closed";i.innerHTML=`<div class="gd-bh-closed text-center">${a}</div>`}this.setValue()}attachRemoveHandlers(){this.wrap.querySelectorAll(".gd-bh-remove").forEach(t=>{const i=t.cloneNode(!0);t.parentNode.replaceChild(i,t),i.addEventListener("click",n=>{n.preventDefault(),this.removeSlot(i)})})}attachChangeHandlers(){this.wrap.querySelectorAll(`[name^="${this.field}_f[hours]"]`).forEach(t=>{const i=t.cloneNode(!0);t.parentNode.replaceChild(i,t),i.addEventListener("change",n=>{const r=i.closest(".gd-bh-item");this.handle24Hours(r),this.setValue(),n.preventDefault()})})}handle24HoursChange(o){const t=o.closest(".gd-bh-item"),i=t.querySelector(".gd-bh-hours:first-of-type");if(i)if(o.checked){const n=o.closest(".gd-bh-items").dataset["12am"]?.trim()||"12:00 AM";t.classList.add("gd-bh-item-24hours"),t.querySelectorAll(".input-group").forEach(f=>{f.style.opacity="0.67"});const s=i.querySelector(".gd-alt-open"),a=i.querySelector(".gd-alt-close"),l=i.querySelector('[data-field-alt="open"]'),c=i.querySelector('[data-field-alt="close"]');s&&(s.value=n),a&&(a.value=n),l&&(l.value="00:00",l.dispatchEvent(new Event("change"))),c&&(c.value="00:00")}else t.querySelectorAll(".input-group").forEach(r=>{r.style.opacity="1"})}handle24Hours(o){if(!o)return;let t=!1;o.querySelectorAll(".gd-bh-hours").forEach(r=>{const s=r.querySelector('[data-field-alt="open"]'),a=r.querySelector('[data-field-alt="close"]');if(s&&a){const l=s.value.trim(),c=a.value.trim();l==="00:00"&&c==="00:00"&&(t=!0)}});const n=o.querySelector('.gd-bh-24hours input[type="checkbox"]');n&&(n.checked=t),t?(o.classList.add("gd-bh-item-24hours"),o.querySelectorAll(".input-group").forEach(s=>{s.style.opacity="0.67"})):(o.classList.remove("gd-bh-item-24hours"),o.querySelectorAll(".input-group").forEach(s=>{s.style.opacity="1"}))}setValue(){const o=this.wrap.querySelector(`[name="${this.field}_f_active"]:checked`);let t="";o&&o.value==="1"&&(t=this.toSchema()),this.fieldElement.value=t,this.fieldElement.dispatchEvent(new Event("change"))}toSchema(){const o=this.wrap.querySelectorAll(".gd-bh-item"),t=[];o.forEach(a=>{const l=a.querySelector(".gd-bh-time");if(!l)return;const c=l.dataset.day;if(!c)return;const f=[];a.querySelectorAll(".gd-bh-hours").forEach(u=>{const g=u.querySelector('[data-field-alt="open"]'),p=u.querySelector('[data-field-alt="close"]');if(g){const b=g.value.trim();let v=p?p.value.trim():"";b&&(v||(v="00:00"),f.push(`${b}-${v}`))}}),f.length>0&&t.push(`${c} ${f.join(",")}`)});let i="";t.length>0&&(i+=JSON.stringify(t),i+=",");const n=this.wrap.querySelector('[data-field="timezone_string"]');let r=this.defaultTimezoneString,s=this.defaultOffset;if(n){r=n.value||r;const a=n.querySelector("option:checked");a&&(s=a.dataset.offset||s)}return i+=`["UTC":"${s}","Timezone":"${r}"]`,i}initTimePickers(){typeof window.aui_init=="function"&&window.aui_init()}async getTimezone(o,t=""){const i=o.closest("form");if(!i)return;const n=i.querySelector(`[name="${t}latitude"]`),r=i.querySelector(`[name="${t}longitude"]`);if(!n||!r)return;const s=n.value.trim(),a=r.value.trim();if(!(!s||!a))try{const c=await(await fetch(window.geodir_params.gd_ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"geodir_timezone_data",security:window.geodir_params.basic_nonce,lat:s,lon:a,ts:Math.round(Date.now()/1e3).toString()})})).json();c.success&&c.data.timeZoneId?(o.value=c.data.timeZoneId,o.dispatchEvent(new Event("change"))):c.data&&c.data.error&&console.log(c.data.error)}catch(l){console.error("Timezone fetch error:",l)}finally{window.gdTzApi=!1}}}function F(e){e.querySelectorAll(".gd-bh-row").forEach(t=>{const i=t.querySelector('[name*="business_hours"]');if(i){const n=i.getAttribute("name");new K({field:n,offset:window.geodir_params?.gmt_offset||"0"})}})}function E(){const e=document.querySelector("#geodirectory-add-post");e&&X(e);const o=document.querySelector("form#post .postbox#geodir_post_info");o&&ee(o)}function X(e){console.log("Initializing frontend add-listing form"),z(e),L(e),F(e),C(e),te(e),oe(e),ie(e),ne(e),re(e),se(e)}function ee(e){console.log("Initializing backend add-listing form");const o=e.closest("form#post");o&&(L(o),F(o),C(o),o.addEventListener("submit",t=>{if(!k(o))return t.preventDefault(),ae(o),!1}))}function C(e){e.querySelectorAll('.required_field:not([style*="display: none"]) [field_type]:not([style*="display: none"]), .required_field:not([style*="display: none"]) .editor textarea').forEach(n=>{n.addEventListener("blur",function(){setTimeout(()=>{h(this)},100)})}),e.querySelectorAll('.required_field:not([style*="display: none"]) input[type="checkbox"], .required_field:not([style*="display: none"]) input[type="radio"]').forEach(n=>{n.addEventListener("click",function(){h(this)})}),e.querySelectorAll('.required_field:not([style*="display: none"]) select.geodir-select').forEach(n=>{n.addEventListener("change",function(){h(this)})})}function te(e){e.addEventListener("submit",async o=>{await U(o,e)})}function oe(e){const o=document.querySelector(".geodir_preview_button");o&&o.addEventListener("click",async()=>(await O(e),_(e)))}function ie(e){e.addEventListener("change",()=>{try{typeof window.aui_conditional_fields=="function"&&window.aui_conditional_fields("#geodirectory-add-post,#post")}catch(o){console.log("Conditional fields error:",o.message)}});try{typeof window.aui_conditional_fields=="function"&&window.aui_conditional_fields("#geodirectory-add-post,#post")}catch(o){console.log("Conditional fields error:",o.message)}}function ne(e){const o=e.querySelector(".gd-hidden-latlng");if(!o)return;e.querySelectorAll('[type="submit"]').forEach(i=>{i.addEventListener("click",()=>{const n=e.querySelector('[name="latitude"]'),r=e.querySelector('[name="longitude"]');if(n&&r){const s=n.value.trim(),a=r.value.trim();(!s||!a)&&o.classList.remove("d-none")}})})}function re(e){e.querySelectorAll(".gd-locate-me-btn").forEach(t=>{t.addEventListener("click",function(){typeof window.gdGeoLocateMe=="function"&&window.gdGeoLocateMe(this,"add-listing")})})}function se(e){const o=e.querySelector("select#post_tags");o&&o.spellcheck&&setTimeout(()=>{const t=e.querySelector('[data-argument="post_tags"] input.select2-search__field');t&&(t.spellcheck=!0)},5e3)}function ae(e){const o=e.querySelector('.geodir_message_error:not([style*="display: none"])');if(o){const t=o.closest(".required_field");t&&D(t,100)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",E):E();typeof window<"u"&&(window.geodir_validate_field=h,window.geodir_validate_submit=_,window.geodir_validate_admin_submit=e=>k(e),window.geodir_delete_revision=()=>{const e=document.querySelector("#geodirectory-add-post")||document.querySelector("form#post");e&&G(e)});
//# sourceMappingURL=geodir-add-listing.js.map
})();