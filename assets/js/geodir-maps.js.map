{"version":3,"file":"geodir-maps.js","sources":["../../resources/scripts/maps/core/MapProvider.js","../../resources/scripts/maps/core/GoogleMapProvider.js","../../resources/scripts/maps/core/OSMMapProvider.js","../../resources/scripts/maps/core/MapFactory.js","../../resources/scripts/maps/features/CountryRules.js","../../resources/scripts/maps/features/Geocoding.js","../../resources/scripts/maps/features/AddressField.js","../../resources/scripts/maps/index.js"],"sourcesContent":["/**\n * MapProvider - Abstract base class for map implementations\n *\n * Provides a common interface for Google Maps and OpenStreetMap implementations.\n * All map provider implementations must extend this class.\n */\nexport class MapProvider {\n\t/**\n\t * Constructor\n\t * @param {string} elementId - The DOM element ID for the map\n\t * @param {Object} options - Map configuration options\n\t */\n\tconstructor(elementId, options = {}) {\n\t\tthis.elementId = elementId;\n\t\tthis.options = options;\n\t\tthis.map = null;\n\t\tthis.markers = [];\n\t}\n\n\t/**\n\t * Initialize the map\n\t * Must be implemented by subclasses\n\t */\n\tinit() {\n\t\tthrow new Error('MapProvider.init() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Create a marker on the map\n\t * Must be implemented by subclasses\n\t * @param {Object} options - Marker options (lat, lng, icon, draggable, etc.)\n\t * @returns {Object} The created marker object\n\t */\n\tcreateMarker(options) {\n\t\tthrow new Error('MapProvider.createMarker() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Get the center of the map\n\t * Must be implemented by subclasses\n\t * @returns {Object} LatLng object {lat, lng}\n\t */\n\tgetCenter() {\n\t\tthrow new Error('MapProvider.getCenter() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Set the center of the map\n\t * Must be implemented by subclasses\n\t * @param {number} lat - Latitude\n\t * @param {number} lng - Longitude\n\t */\n\tsetCenter(lat, lng) {\n\t\tthrow new Error('MapProvider.setCenter() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Pan the map to a location\n\t * Must be implemented by subclasses\n\t * @param {number} lat - Latitude\n\t * @param {number} lng - Longitude\n\t */\n\tpanTo(lat, lng) {\n\t\tthrow new Error('MapProvider.panTo() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Get the current zoom level\n\t * Must be implemented by subclasses\n\t * @returns {number} Zoom level\n\t */\n\tgetZoom() {\n\t\tthrow new Error('MapProvider.getZoom() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Set the zoom level\n\t * Must be implemented by subclasses\n\t * @param {number} zoom - Zoom level\n\t */\n\tsetZoom(zoom) {\n\t\tthrow new Error('MapProvider.setZoom() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Forward geocode an address to coordinates\n\t * Must be implemented by subclasses\n\t * @param {string|Object} request - Address string or geocode request object\n\t * @returns {Promise<Object>} Geocode results\n\t */\n\tgeocode(request) {\n\t\tthrow new Error('MapProvider.geocode() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Reverse geocode coordinates to an address\n\t * Must be implemented by subclasses\n\t * @param {number} lat - Latitude\n\t * @param {number} lng - Longitude\n\t * @returns {Promise<Object>} Reverse geocode results\n\t */\n\treverseGeocode(lat, lng) {\n\t\tthrow new Error('MapProvider.reverseGeocode() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Add event listener to the map\n\t * Must be implemented by subclasses\n\t * @param {string} event - Event name\n\t * @param {Function} callback - Event handler\n\t */\n\taddEventListener(event, callback) {\n\t\tthrow new Error('MapProvider.addEventListener() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Get the map type name\n\t * @returns {string} 'google' or 'osm'\n\t */\n\tgetType() {\n\t\treturn this.mapType;\n\t}\n\n\t/**\n\t * Check if the map is ready\n\t * @returns {boolean}\n\t */\n\tisReady() {\n\t\treturn this.map !== null;\n\t}\n}\n","/**\n * GoogleMapProvider - Google Maps implementation\n *\n * Wraps Google Maps API in the MapProvider interface.\n */\nimport { MapProvider } from './MapProvider.js';\n\nexport class GoogleMapProvider extends MapProvider {\n\tconstructor(elementId, options = {}) {\n\t\tsuper(elementId, options);\n\t\tthis.mapType = 'google';\n\t\tthis.geocoder = null;\n\t}\n\n\t/**\n\t * Initialize Google Maps\n\t */\n\tinit() {\n\t\tconsole.log('[GoogleMapProvider] Initializing for element:', this.elementId);\n\t\tconsole.log('[GoogleMapProvider] Options:', this.options);\n\n\t\tif (!window.google || !google.maps) {\n\t\t\tconsole.error('[GoogleMapProvider] Google Maps not loaded');\n\t\t\treturn false;\n\t\t}\n\n\t\tconsole.log('[GoogleMapProvider] Google Maps API is available');\n\n\t\t// Initialize geocoder\n\t\tthis.geocoder = new google.maps.Geocoder();\n\t\tconsole.log('[GoogleMapProvider] Geocoder initialized');\n\n\t\t// Get map element\n\t\tconst mapElement = document.getElementById(this.elementId);\n\t\tconsole.log('[GoogleMapProvider] Map element:', mapElement);\n\n\t\tif (!mapElement) {\n\t\t\tconsole.error(`[GoogleMapProvider] Map element #${this.elementId} not found`);\n\t\t\treturn false;\n\t\t}\n\n\t\t// Map type conversion\n\t\tconst mapTypeId = this.options.maptype ?\n\t\t\tgoogle.maps.MapTypeId[this.options.maptype] || google.maps.MapTypeId.ROADMAP :\n\t\t\tgoogle.maps.MapTypeId.ROADMAP;\n\n\t\tconsole.log('[GoogleMapProvider] Creating map with options:', {\n\t\t\tcenter: { lat: this.options.latitude || 0, lng: this.options.longitude || 0 },\n\t\t\tzoom: this.options.zoom || 12,\n\t\t\tmapTypeId: mapTypeId\n\t\t});\n\n\t\t// Create map directly with Google Maps API\n\t\tthis.map = new google.maps.Map(mapElement, {\n\t\t\tcenter: {\n\t\t\t\tlat: parseFloat(this.options.latitude) || 0,\n\t\t\t\tlng: parseFloat(this.options.longitude) || 0\n\t\t\t},\n\t\t\tzoom: parseInt(this.options.zoom) || 12,\n\t\t\tmapTypeId: mapTypeId,\n\t\t\tstreetViewControl: this.options.streetViewControl !== false,\n\t\t\tscrollwheel: this.options.scrollwheel !== false,\n\t\t\t...this.options.mapOptions\n\t\t});\n\n\t\tconsole.log('[GoogleMapProvider] Map initialized:', this.map ? 'SUCCESS' : 'FAILED');\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Create a marker\n\t */\n\tcreateMarker(options) {\n\t\tconst lat = parseFloat(options.lat || options.latitude) || 0;\n\t\tconst lng = parseFloat(options.lng || options.longitude) || 0;\n\n\t\tconst markerOptions = {\n\t\t\tposition: { lat, lng },\n\t\t\tmap: this.map,\n\t\t\tdraggable: options.draggable !== false,\n\t\t\ttitle: options.title || ''\n\t\t};\n\n\t\t// Add custom icon if provided\n\t\tif (options.icon) {\n\t\t\tconst iconOptions = {\n\t\t\t\turl: options.icon\n\t\t\t};\n\n\t\t\t// Add size if provided\n\t\t\tif (options.w && options.h) {\n\t\t\t\ticonOptions.scaledSize = new google.maps.Size(\n\t\t\t\t\tparseInt(options.w),\n\t\t\t\t\tparseInt(options.h)\n\t\t\t\t);\n\t\t\t\ticonOptions.anchor = new google.maps.Point(\n\t\t\t\t\tparseInt(options.w) / 2,\n\t\t\t\t\tparseInt(options.h)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmarkerOptions.icon = iconOptions;\n\t\t}\n\n\t\tconst marker = new google.maps.Marker(markerOptions);\n\n\t\tthis.markers.push(marker);\n\t\treturn marker;\n\t}\n\n\t/**\n\t * Get center of map\n\t */\n\tgetCenter() {\n\t\tif (!this.map) return null;\n\t\tconst center = this.map.getCenter();\n\t\treturn {\n\t\t\tlat: center.lat(),\n\t\t\tlng: center.lng()\n\t\t};\n\t}\n\n\t/**\n\t * Set center of map\n\t */\n\tsetCenter(lat, lng) {\n\t\tif (!this.map) return;\n\t\tthis.map.setCenter(new google.maps.LatLng(lat, lng));\n\t}\n\n\t/**\n\t * Pan to location\n\t */\n\tpanTo(lat, lng) {\n\t\tif (!this.map) return;\n\t\tthis.map.panTo(new google.maps.LatLng(lat, lng));\n\t}\n\n\t/**\n\t * Get zoom level\n\t */\n\tgetZoom() {\n\t\tif (!this.map) return null;\n\t\treturn this.map.getZoom();\n\t}\n\n\t/**\n\t * Set zoom level\n\t */\n\tsetZoom(zoom) {\n\t\tif (!this.map) return;\n\t\tthis.map.setZoom(zoom);\n\t}\n\n\t/**\n\t * Forward geocode\n\t */\n\tgeocode(request) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!this.geocoder) {\n\t\t\t\treject(new Error('Geocoder not initialized'));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst geocodeRequest = typeof request === 'string'\n\t\t\t\t? { address: request }\n\t\t\t\t: request;\n\n\t\t\tthis.geocoder.geocode(geocodeRequest, (results, status) => {\n\t\t\t\tif (status === google.maps.GeocoderStatus.OK) {\n\t\t\t\t\tresolve(results);\n\t\t\t\t} else {\n\t\t\t\t\treject(new Error(`Geocoding failed: ${status}`));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Reverse geocode\n\t */\n\treverseGeocode(lat, lng) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!this.geocoder) {\n\t\t\t\treject(new Error('Geocoder not initialized'));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.geocoder.geocode({\n\t\t\t\tlatLng: new google.maps.LatLng(lat, lng)\n\t\t\t}, (results, status) => {\n\t\t\t\tif (status === google.maps.GeocoderStatus.OK) {\n\t\t\t\t\tresolve(results);\n\t\t\t\t} else {\n\t\t\t\t\treject(new Error(`Reverse geocoding failed: ${status}`));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Add event listener\n\t */\n\taddEventListener(event, callback) {\n\t\tif (!this.map) return;\n\n\t\t// Map event names to Google Maps events\n\t\tconst eventMap = {\n\t\t\t'dragend': 'dragend',\n\t\t\t'zoom_changed': 'zoom_changed',\n\t\t\t'click': 'click'\n\t\t};\n\n\t\tconst googleEvent = eventMap[event] || event;\n\t\tgoogle.maps.event.addListener(this.map, googleEvent, callback);\n\t}\n\n\t/**\n\t * Add marker event listener\n\t */\n\taddMarkerListener(marker, event, callback) {\n\t\tif (!marker) return;\n\t\tgoogle.maps.event.addListener(marker, event, callback);\n\t}\n}\n","/**\n * OSMMapProvider - OpenStreetMap/Leaflet implementation\n *\n * Wraps Leaflet (OSM) in the MapProvider interface.\n */\nimport { MapProvider } from './MapProvider.js';\n\nexport class OSMMapProvider extends MapProvider {\n\tconstructor(elementId, options = {}) {\n\t\tsuper(elementId, options);\n\t\tthis.mapType = 'osm';\n\t}\n\n\t/**\n\t * Initialize Leaflet map\n\t */\n\tinit() {\n\t\tif (!window.L || !L.version) {\n\t\t\tconsole.error('Leaflet not loaded');\n\t\t\treturn false;\n\t\t}\n\n\t\t// Get map element\n\t\tconst mapElement = document.getElementById(this.elementId);\n\t\tif (!mapElement) {\n\t\t\tconsole.error(`Map element #${this.elementId} not found`);\n\t\t\treturn false;\n\t\t}\n\n\t\t// Create map directly with Leaflet API\n\t\tthis.map = L.map(this.elementId, {\n\t\t\tcenter: [\n\t\t\t\tparseFloat(this.options.latitude) || 0,\n\t\t\t\tparseFloat(this.options.longitude) || 0\n\t\t\t],\n\t\t\tzoom: parseInt(this.options.zoom) || 12,\n\t\t\tscrollWheelZoom: this.options.scrollwheel !== false,\n\t\t\t...this.options.mapOptions\n\t\t});\n\n\t\t// Add OpenStreetMap tile layer\n\t\tL.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n\t\t\tattribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors',\n\t\t\tmaxZoom: 19\n\t\t}).addTo(this.map);\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Create a marker\n\t */\n\tcreateMarker(options) {\n\t\tconst lat = parseFloat(options.lat || options.latitude) || 0;\n\t\tconst lng = parseFloat(options.lng || options.longitude) || 0;\n\n\t\tconst markerOptions = {\n\t\t\tdraggable: options.draggable !== false,\n\t\t\ttitle: options.title || ''\n\t\t};\n\n\t\t// Add custom icon if provided\n\t\tif (options.icon) {\n\t\t\tconst iconOptions = {\n\t\t\t\ticonUrl: options.icon\n\t\t\t};\n\n\t\t\t// Add size if provided\n\t\t\tif (options.w && options.h) {\n\t\t\t\ticonOptions.iconSize = [parseInt(options.w), parseInt(options.h)];\n\t\t\t\ticonOptions.iconAnchor = [\n\t\t\t\t\tparseInt(options.w) / 2,\n\t\t\t\t\tparseInt(options.h)\n\t\t\t\t];\n\t\t\t\ticonOptions.popupAnchor = [0, -parseInt(options.h)];\n\t\t\t}\n\n\t\t\tmarkerOptions.icon = L.icon(iconOptions);\n\t\t}\n\n\t\tconst marker = L.marker([lat, lng], markerOptions).addTo(this.map);\n\n\t\tthis.markers.push(marker);\n\t\treturn marker;\n\t}\n\n\t/**\n\t * Get center of map\n\t */\n\tgetCenter() {\n\t\tif (!this.map) return null;\n\t\tconst center = this.map.getCenter();\n\t\treturn {\n\t\t\tlat: center.lat,\n\t\t\tlng: center.lng\n\t\t};\n\t}\n\n\t/**\n\t * Set center of map\n\t */\n\tsetCenter(lat, lng) {\n\t\tif (!this.map) return;\n\t\tthis.map.setView([lat, lng]);\n\t}\n\n\t/**\n\t * Pan to location\n\t */\n\tpanTo(lat, lng) {\n\t\tif (!this.map) return;\n\t\tthis.map.panTo(new L.LatLng(lat, lng));\n\t}\n\n\t/**\n\t * Get zoom level\n\t */\n\tgetZoom() {\n\t\tif (!this.map) return null;\n\t\treturn this.map.getZoom();\n\t}\n\n\t/**\n\t * Set zoom level\n\t */\n\tsetZoom(zoom) {\n\t\tif (!this.map) return;\n\t\tthis.map.setZoom(zoom);\n\t}\n\n\t/**\n\t * Forward geocode using OSM Nominatim\n\t */\n\tasync geocode(request) {\n\t\tconst address = typeof request === 'string' ? request : request.address;\n\t\tconst countryCode = request.country || '';\n\n\t\tif (!address) {\n\t\t\tthrow new Error('Address is required for geocoding');\n\t\t}\n\n\t\ttry {\n\t\t\tconst params = new URLSearchParams({\n\t\t\t\tq: address,\n\t\t\t\tformat: 'json',\n\t\t\t\taddressdetails: '1',\n\t\t\t\tlimit: '1'\n\t\t\t});\n\n\t\t\tif (countryCode) {\n\t\t\t\tparams.append('countrycodes', countryCode.toLowerCase());\n\t\t\t}\n\n\t\t\tconst response = await fetch(`https://nominatim.openstreetmap.org/search?${params}`);\n\t\t\tconst results = await response.json();\n\n\t\t\treturn results.map(result => this.normalizeOSMResult(result));\n\t\t} catch (error) {\n\t\t\tthrow new Error(`OSM Geocoding failed: ${error.message}`);\n\t\t}\n\t}\n\n\t/**\n\t * Reverse geocode using OSM Nominatim\n\t */\n\tasync reverseGeocode(lat, lng) {\n\t\ttry {\n\t\t\tconst params = new URLSearchParams({\n\t\t\t\tlat: lat.toString(),\n\t\t\t\tlon: lng.toString(),\n\t\t\t\tformat: 'json',\n\t\t\t\taddressdetails: '1'\n\t\t\t});\n\n\t\t\tconst response = await fetch(`https://nominatim.openstreetmap.org/reverse?${params}`);\n\t\t\tconst result = await response.json();\n\n\t\t\treturn [this.normalizeOSMResult(result)];\n\t\t} catch (error) {\n\t\t\tthrow new Error(`OSM Reverse geocoding failed: ${error.message}`);\n\t\t}\n\t}\n\n\t/**\n\t * Normalize OSM result to match Google Maps format\n\t */\n\tnormalizeOSMResult(osmResult) {\n\t\tconst address = osmResult.address || {};\n\n\t\treturn {\n\t\t\tdisplay_address: osmResult.display_name,\n\t\t\tlat: parseFloat(osmResult.lat),\n\t\t\tlon: parseFloat(osmResult.lon),\n\t\t\tpostcode: address.postcode || '',\n\t\t\tcity: address.city || address.town || address.village || '',\n\t\t\tstate: address.state || '',\n\t\t\tcountry: address.country || '',\n\t\t\tcountry_code: address.country_code ? address.country_code.toUpperCase() : '',\n\t\t\taddress: address,\n\t\t\t// GB split support\n\t\t\tgb_country: this.getGBCountry(address)\n\t\t};\n\t}\n\n\t/**\n\t * Get specific country for GB addresses (England, Scotland, Wales, Northern Ireland)\n\t */\n\tgetGBCountry(address) {\n\t\tif (address.country_code !== 'gb') return null;\n\n\t\tconst state = address.state || '';\n\t\tconst gbCountries = ['England', 'Northern Ireland', 'Scotland', 'Wales'];\n\n\t\tfor (const country of gbCountries) {\n\t\t\tif (state.includes(country)) {\n\t\t\t\treturn country;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Add event listener\n\t */\n\taddEventListener(event, callback) {\n\t\tif (!this.map) return;\n\n\t\t// Map event names to Leaflet events\n\t\tconst eventMap = {\n\t\t\t'dragend': 'dragend',\n\t\t\t'zoom_changed': 'zoomend',\n\t\t\t'click': 'click'\n\t\t};\n\n\t\tconst leafletEvent = eventMap[event] || event;\n\t\tthis.map.on(leafletEvent, callback);\n\t}\n\n\t/**\n\t * Add marker event listener\n\t */\n\taddMarkerListener(marker, event, callback) {\n\t\tif (!marker) return;\n\t\tmarker.on(event, callback);\n\t}\n}\n","/**\n * MapFactory - Factory for creating map provider instances\n *\n * Automatically detects which map API is available and creates the appropriate provider.\n */\nimport { GoogleMapProvider } from './GoogleMapProvider.js';\nimport { OSMMapProvider } from './OSMMapProvider.js';\n\nexport class MapFactory {\n\t/**\n\t * Create a map provider instance\n\t *\n\t * @param {string} elementId - The DOM element ID for the map\n\t * @param {Object} options - Map configuration options\n\t * @param {string} options.preferredProvider - 'google', 'osm', or 'auto' (default)\n\t * @returns {MapProvider|null} Map provider instance or null if no provider available\n\t */\n\tstatic create(elementId, options = {}) {\n\t\tconsole.log('[MapFactory] Creating map provider for element:', elementId);\n\t\tconsole.log('[MapFactory] Options:', options);\n\n\t\tconst provider = options.preferredProvider || MapFactory.detectProvider();\n\t\tconsole.log('[MapFactory] Detected/preferred provider:', provider);\n\t\tconsole.log('[MapFactory] Google available?', MapFactory.isGoogleMapsAvailable());\n\t\tconsole.log('[MapFactory] OSM available?', MapFactory.isOSMAvailable());\n\n\t\tswitch (provider) {\n\t\t\tcase 'google':\n\t\t\t\tif (MapFactory.isGoogleMapsAvailable()) {\n\t\t\t\t\tconsole.log('[MapFactory] Creating GoogleMapProvider');\n\t\t\t\t\treturn new GoogleMapProvider(elementId, options);\n\t\t\t\t}\n\t\t\t\tconsole.warn('[MapFactory] Google Maps not available, falling back to OSM');\n\t\t\t\tif (MapFactory.isOSMAvailable()) {\n\t\t\t\t\tconsole.log('[MapFactory] Creating OSMMapProvider (fallback)');\n\t\t\t\t\treturn new OSMMapProvider(elementId, options);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'osm':\n\t\t\t\tif (MapFactory.isOSMAvailable()) {\n\t\t\t\t\tconsole.log('[MapFactory] Creating OSMMapProvider');\n\t\t\t\t\treturn new OSMMapProvider(elementId, options);\n\t\t\t\t}\n\t\t\t\tconsole.warn('[MapFactory] OSM not available, falling back to Google Maps');\n\t\t\t\tif (MapFactory.isGoogleMapsAvailable()) {\n\t\t\t\t\tconsole.log('[MapFactory] Creating GoogleMapProvider (fallback)');\n\t\t\t\t\treturn new GoogleMapProvider(elementId, options);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'auto':\n\t\t\tdefault:\n\t\t\t\t// Try Google first, then OSM\n\t\t\t\tif (MapFactory.isGoogleMapsAvailable()) {\n\t\t\t\t\tconsole.log('[MapFactory] Creating GoogleMapProvider (auto)');\n\t\t\t\t\treturn new GoogleMapProvider(elementId, options);\n\t\t\t\t}\n\t\t\t\tif (MapFactory.isOSMAvailable()) {\n\t\t\t\t\tconsole.log('[MapFactory] Creating OSMMapProvider (auto)');\n\t\t\t\t\treturn new OSMMapProvider(elementId, options);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\n\t\tconsole.error('[MapFactory] No map provider available!');\n\t\treturn null;\n\t}\n\n\t/**\n\t * Detect which map provider is available\n\t *\n\t * @returns {string} 'google', 'osm', or 'none'\n\t */\n\tstatic detectProvider() {\n\t\tconsole.log('[MapFactory] Detecting provider... window.gdSetMap:', window.gdSetMap);\n\n\t\t// Check global gdSetMap setting first\n\t\tif (window.gdSetMap) {\n\t\t\tif ((window.gdSetMap === 'google' || window.gdSetMap === 'auto') && MapFactory.isGoogleMapsAvailable()) {\n\t\t\t\tconsole.log('[MapFactory] Using Google Maps (from gdSetMap)');\n\t\t\t\treturn 'google';\n\t\t\t}\n\t\t\tif ((window.gdSetMap === 'osm' || window.gdSetMap === 'auto') && MapFactory.isOSMAvailable()) {\n\t\t\t\tconsole.log('[MapFactory] Using OSM (from gdSetMap)');\n\t\t\t\treturn 'osm';\n\t\t\t}\n\t\t}\n\n\t\t// Auto-detect based on what's loaded\n\t\tif (MapFactory.isGoogleMapsAvailable()) {\n\t\t\tconsole.log('[MapFactory] Auto-detected Google Maps');\n\t\t\treturn 'google';\n\t\t}\n\t\tif (MapFactory.isOSMAvailable()) {\n\t\t\tconsole.log('[MapFactory] Auto-detected OSM');\n\t\t\treturn 'osm';\n\t\t}\n\n\t\tconsole.log('[MapFactory] No provider detected');\n\t\treturn 'none';\n\t}\n\n\t/**\n\t * Check if Google Maps is available\n\t *\n\t * @returns {boolean}\n\t */\n\tstatic isGoogleMapsAvailable() {\n\t\treturn !!(window.google && typeof google.maps !== 'undefined');\n\t}\n\n\t/**\n\t * Check if OSM/Leaflet is available\n\t *\n\t * @returns {boolean}\n\t */\n\tstatic isOSMAvailable() {\n\t\treturn !!(window.L && typeof L.version !== 'undefined');\n\t}\n\n\t/**\n\t * Get the name of the currently available provider\n\t *\n\t * @returns {string} 'google', 'osm', or 'none'\n\t */\n\tstatic getAvailableProvider() {\n\t\treturn MapFactory.detectProvider();\n\t}\n}\n","/**\n * CountryRules - Country-specific address parsing rules\n *\n * Contains all the logic for parsing geocode results differently based on country.\n * This is extracted from the massive inline JavaScript in the original template.\n */\nexport class CountryRules {\n\t/**\n\t * Countries that use administrative_area_level_2 for region instead of level_1\n\t */\n\tstatic regionLevel2Countries = ['GB', 'ES'];\n\n\t/**\n\t * Countries with special city parsing rules\n\t */\n\tstatic citySpecialCases = ['IE', 'TR', 'FR'];\n\n\t/**\n\t * Region overrides for countries without regions\n\t */\n\tstatic regionOverrides = {\n\t\t'IM': 'Isle of Man',\n\t\t'SG': 'Singapore',\n\t\t'VA': 'Vatican City State'\n\t};\n\n\t/**\n\t * Region name fixes\n\t */\n\tstatic regionFixes = {\n\t\t'Brussels Hoofdstedelijk Gewest': 'Brussels'\n\t};\n\n\t/**\n\t * GB-specific region fixes\n\t */\n\tstatic gbRegionFixes = {\n\t\t'Stoke-on-Trent': 'Staffordshire'\n\t};\n\n\t/**\n\t * Parse address components from geocode result\n\t *\n\t * @param {Array} responses - Geocode responses (Google or normalized OSM)\n\t * @param {Object} options - Parsing options\n\t * @param {string} options.mapType - 'google' or 'osm'\n\t * @returns {Object} Parsed address components\n\t */\n\tstatic parseAddress(responses, options = {}) {\n\t\tif (!responses || responses.length === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst mapType = options.mapType || 'google';\n\n\t\t// For OSM, the response is already normalized\n\t\tif (mapType === 'osm') {\n\t\t\treturn CountryRules.parseOSMAddress(responses[0]);\n\t\t}\n\n\t\t// For Google Maps\n\t\treturn CountryRules.parseGoogleAddress(responses);\n\t}\n\n\t/**\n\t * Parse OSM address (already normalized by OSMMapProvider)\n\t */\n\tstatic parseOSMAddress(result) {\n\t\treturn {\n\t\t\tstreet: result.display_address || '',\n\t\t\tstreet2: CountryRules.getStreet2FromOSM(result),\n\t\t\tzip: result.postcode || '',\n\t\t\tcity: result.city || '',\n\t\t\tregion: result.state || '',\n\t\t\tcountry: result.country || '',\n\t\t\tcountryISO: result.country_code || '',\n\t\t\tbaseCountry: result.gb_country ? result.country : ''\n\t\t};\n\t}\n\n\t/**\n\t * Get street2 from OSM address (building, hotel, etc.)\n\t */\n\tstatic getStreet2FromOSM(result) {\n\t\tconst address = result.address || {};\n\n\t\tif (address.building) return address.building;\n\t\tif (address.department_store) return address.department_store;\n\t\tif (address.hotel) return address.hotel;\n\n\t\treturn '';\n\t}\n\n\t/**\n\t * Parse Google Maps address\n\t */\n\tstatic parseGoogleAddress(responses) {\n\t\tconst parsed = {\n\t\t\tstreet: '',\n\t\t\tstreet2: '',\n\t\t\tzip: '',\n\t\t\tcity: '',\n\t\t\tregion: '',\n\t\t\tcountry: '',\n\t\t\tcountryISO: '',\n\t\t\tbaseCountry: ''\n\t\t};\n\n\t\t// Extract address components from first result\n\t\tconst components = CountryRules.extractComponents(responses);\n\n\t\t// Get country first as it affects other parsing\n\t\tparsed.country = components.country.long_name || '';\n\t\tparsed.countryISO = components.country.short_name || '';\n\n\t\t// Parse street address\n\t\tconst streetParts = CountryRules.parseStreet(responses[0], components);\n\t\tparsed.street = streetParts.street;\n\t\tparsed.street2 = streetParts.street2;\n\n\t\t// Parse region\n\t\tparsed.region = CountryRules.parseRegion(components, parsed.countryISO);\n\n\t\t// Parse city\n\t\tparsed.city = CountryRules.parseCity(components, parsed.countryISO);\n\n\t\t// Parse zip\n\t\tparsed.zip = CountryRules.parseZip(responses, components, parsed.region);\n\n\t\t// Handle GB split\n\t\tif (parsed.countryISO === 'GB' && CountryRules.isGBSplitEnabled()) {\n\t\t\tconst gbCountry = CountryRules.getGBCountry(components);\n\t\t\tif (gbCountry) {\n\t\t\t\tparsed.baseCountry = parsed.country;\n\t\t\t\tparsed.country = gbCountry;\n\t\t\t}\n\t\t}\n\n\t\t// Vatican City fix\n\t\tif (parsed.city === 'Vatican City') {\n\t\t\tparsed.countryISO = 'VA';\n\t\t\tparsed.region = 'Vatican City State';\n\t\t\tparsed.country = 'Holy See';\n\t\t}\n\n\t\treturn parsed;\n\t}\n\n\t/**\n\t * Extract all address components from responses\n\t */\n\tstatic extractComponents(responses) {\n\t\tconst components = {\n\t\t\tstreet_number: {},\n\t\t\troute: {},\n\t\t\tpremise: {},\n\t\t\testablishment: {},\n\t\t\tadministrative_area_level_1: {},\n\t\t\tadministrative_area_level_2: {},\n\t\t\tadministrative_area_level_3: {},\n\t\t\tsublocality_level_1: {},\n\t\t\tpostal_town: {},\n\t\t\tlocality: {},\n\t\t\tsublocality: {},\n\t\t\tcountry: {},\n\t\t\tpostal_code: {},\n\t\t\tpostal_code_prefix: {}\n\t\t};\n\n\t\t// Get locality info from the locality response if available\n\t\tresponses.forEach(response => {\n\t\t\tif (response.types && response.types[0] === 'locality') {\n\t\t\t\tresponse.address_components.forEach(addr => {\n\t\t\t\t\tconst types = addr.types || [];\n\t\t\t\t\ttypes.forEach(type => {\n\t\t\t\t\t\tif (components.hasOwnProperty(type) && !components[type].long_name) {\n\t\t\t\t\t\t\tcomponents[type] = addr;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\t// Get info from first response\n\t\tif (responses[0] && responses[0].address_components) {\n\t\t\tresponses[0].address_components.forEach(addr => {\n\t\t\t\tconst types = addr.types || [];\n\t\t\t\ttypes.forEach(type => {\n\t\t\t\t\tif (components.hasOwnProperty(type) && !components[type].long_name) {\n\t\t\t\t\t\tcomponents[type] = addr;\n\t\t\t\t\t}\n\t\t\t\t\t// Handle sublocality as secondary type\n\t\t\t\t\tif (type === 'sublocality' || types[1] === 'sublocality') {\n\t\t\t\t\t\tif (!components.sublocality.long_name) {\n\t\t\t\t\t\t\tcomponents.sublocality = addr;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn components;\n\t}\n\n\t/**\n\t * Parse street address\n\t */\n\tstatic parseStreet(firstResult, components) {\n\t\tlet street = '';\n\t\tlet street2 = '';\n\n\t\tconst formatted = firstResult.formatted_address || '';\n\t\tconst addressArray = formatted.split(',', 2);\n\n\t\t// Try to parse from formatted address\n\t\tif (addressArray.length > 1) {\n\t\t\tstreet = CountryRules.parseStreetFromFormatted(addressArray, components);\n\t\t}\n\n\t\t// Fallback to components\n\t\tif (!street || street === 'none') {\n\t\t\tif (components.establishment.long_name && addressArray[1]) {\n\t\t\t\tstreet = addressArray[1];\n\t\t\t\tstreet2 = addressArray[0];\n\t\t\t} else if (street === 'none') {\n\t\t\t\tstreet = addressArray[0] || '';\n\t\t\t}\n\t\t}\n\n\t\t// Final fallback\n\t\tif (!street) {\n\t\t\tif (components.street_number.long_name) {\n\t\t\t\tstreet += components.street_number.long_name + ' ';\n\t\t\t}\n\t\t\tif (components.route.long_name) {\n\t\t\t\tstreet += components.route.long_name;\n\t\t\t}\n\t\t}\n\n\t\t// Street2 from premise if not already set\n\t\tif (!street2 && components.premise.long_name && components.premise.long_name !== street) {\n\t\t\tstreet2 = components.premise.long_name;\n\t\t}\n\n\t\t// Handle Japanese addresses\n\t\tif (components.country.short_name === 'JP' && formatted) {\n\t\t\tstreet = CountryRules.parseJapaneseStreet(formatted, components);\n\t\t}\n\n\t\treturn { street: street.trim(), street2: street2.trim() };\n\t}\n\n\t/**\n\t * Parse street from formatted address parts\n\t */\n\tstatic parseStreetFromFormatted(addressArray, components) {\n\t\tconst checks = [\n\t\t\t{ component: 'street_number', field: 'long_name' },\n\t\t\t{ component: 'street_number', field: 'short_name' },\n\t\t\t{ component: 'premise', field: 'long_name' },\n\t\t\t{ component: 'premise', field: 'short_name' }\n\t\t];\n\n\t\tfor (const check of checks) {\n\t\t\tconst value = components[check.component][check.field];\n\t\t\tif (value) {\n\t\t\t\t// Check against both address parts\n\t\t\t\tif (value.toLowerCase() === addressArray[0].toLowerCase().trim()) {\n\t\t\t\t\treturn value + ', ' + addressArray[1];\n\t\t\t\t}\n\t\t\t\tif (value.toLowerCase() === addressArray[1].toLowerCase().trim()) {\n\t\t\t\t\treturn addressArray[0] + ', ' + value;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn 'none';\n\t}\n\n\t/**\n\t * Parse Japanese street address\n\t */\n\tstatic parseJapaneseStreet(formatted, components) {\n\t\tconst mapLang = window.mapLang || '';\n\t\tif (mapLang !== 'ja') return '';\n\n\t\tlet address = formatted.replace(components.country.long_name + '、', '');\n\n\t\tif (components.postal_code.long_name) {\n\t\t\taddress = address.replace(components.country.long_name + ' 〒' + components.postal_code.long_name, '〒' + components.postal_code.long_name);\n\t\t\taddress = address.replace('〒' + components.postal_code.long_name + ' ', '');\n\t\t}\n\n\t\tlet parts = [];\n\t\tif (components.locality.long_name && address.includes(components.locality.long_name)) {\n\t\t\tparts = address.split(components.locality.long_name);\n\t\t} else if (components.administrative_area_level_1.long_name && address.includes(components.administrative_area_level_1.long_name)) {\n\t\t\tparts = address.split(components.administrative_area_level_1.long_name);\n\t\t}\n\n\t\treturn parts.length > 1 ? parts[parts.length - 1] : address;\n\t}\n\n\t/**\n\t * Parse region/state\n\t */\n\tstatic parseRegion(components, countryISO) {\n\t\tlet region = '';\n\n\t\t// Check for country-specific overrides\n\t\tif (CountryRules.regionOverrides[countryISO]) {\n\t\t\treturn CountryRules.regionOverrides[countryISO];\n\t\t}\n\n\t\t// Determine which administrative level to use\n\t\tif (CountryRules.regionLevel2Countries.includes(countryISO)) {\n\t\t\tregion = components.administrative_area_level_2.long_name || components.administrative_area_level_1.long_name || '';\n\t\t} else {\n\t\t\tregion = components.administrative_area_level_1.long_name || components.administrative_area_level_2.long_name || '';\n\t\t}\n\n\t\t// Greece special case\n\t\tif (countryISO === 'GR' && !region && components.administrative_area_level_3.long_name) {\n\t\t\tregion = components.administrative_area_level_3.long_name;\n\t\t}\n\n\t\t// GB-specific fixes\n\t\tif (countryISO === 'GB') {\n\t\t\tif (CountryRules.gbRegionFixes[region]) {\n\t\t\t\tregion = CountryRules.gbRegionFixes[region];\n\t\t\t}\n\t\t\t// Remove \" Council\" from region names\n\t\t\tregion = region.replace(' Council', '');\n\t\t}\n\n\t\t// General region fixes\n\t\tif (CountryRules.regionFixes[region]) {\n\t\t\tregion = CountryRules.regionFixes[region];\n\t\t}\n\n\t\treturn region;\n\t}\n\n\t/**\n\t * Parse city\n\t */\n\tstatic parseCity(components, countryISO) {\n\t\t// Barbados fix - use locality if sublocality exists\n\t\tif (countryISO === 'BB' && !components.locality.long_name && components.sublocality.long_name) {\n\t\t\tcomponents.locality = components.sublocality;\n\t\t}\n\n\t\t// Country-specific parsing\n\t\tif (countryISO === 'IE') {\n\t\t\treturn CountryRules.parseCityIreland(components);\n\t\t} else if (countryISO === 'TR') {\n\t\t\treturn CountryRules.parseCityTurkey(components);\n\t\t} else if (countryISO === 'FR') {\n\t\t\treturn CountryRules.parseCityFrance(components);\n\t\t}\n\n\t\t// Default city parsing\n\t\tlet city = components.locality.long_name\n\t\t\t|| components.postal_town.long_name\n\t\t\t|| components.sublocality_level_1.long_name\n\t\t\t|| components.administrative_area_level_3.long_name\n\t\t\t|| '';\n\n\t\t// Barbados - use state as city if no city\n\t\tif (countryISO === 'BB' && !city && components.administrative_area_level_1.long_name) {\n\t\t\tcity = components.administrative_area_level_1.long_name;\n\t\t}\n\n\t\treturn city;\n\t}\n\n\t/**\n\t * Parse city for Ireland\n\t */\n\tstatic parseCityIreland(components) {\n\t\tif (components.administrative_area_level_2.long_name && components.administrative_area_level_2.long_name.indexOf(' City') >= 0) {\n\t\t\treturn components.administrative_area_level_2.long_name;\n\t\t}\n\t\treturn components.locality.long_name\n\t\t\t|| components.postal_town.long_name\n\t\t\t|| components.sublocality_level_1.long_name\n\t\t\t|| components.administrative_area_level_3.long_name\n\t\t\t|| '';\n\t}\n\n\t/**\n\t * Parse city for Turkey\n\t */\n\tstatic parseCityTurkey(components) {\n\t\treturn components.locality.long_name\n\t\t\t|| components.postal_town.long_name\n\t\t\t|| components.sublocality_level_1.long_name\n\t\t\t|| components.administrative_area_level_3.long_name\n\t\t\t|| components.administrative_area_level_1.long_name\n\t\t\t|| '';\n\t}\n\n\t/**\n\t * Parse city for France\n\t */\n\tstatic parseCityFrance(components) {\n\t\tif (components.administrative_area_level_2.long_name === 'Paris') {\n\t\t\treturn 'Paris';\n\t\t}\n\t\treturn components.locality.long_name\n\t\t\t|| components.postal_town.long_name\n\t\t\t|| components.sublocality_level_1.long_name\n\t\t\t|| components.administrative_area_level_3.long_name\n\t\t\t|| components.administrative_area_level_1.long_name\n\t\t\t|| '';\n\t}\n\n\t/**\n\t * Parse zip/postal code\n\t */\n\tstatic parseZip(responses, components, region) {\n\t\tlet zip = components.postal_code.long_name || components.postal_code_prefix.long_name || '';\n\n\t\t// Try to find any zip from responses if region is missing\n\t\tif (!region && !zip) {\n\t\t\tzip = CountryRules.findAnyZip(responses);\n\t\t}\n\n\t\treturn zip;\n\t}\n\n\t/**\n\t * Find any zip code from all responses\n\t */\n\tstatic findAnyZip(responses) {\n\t\tfor (const response of responses) {\n\t\t\tif (!response.address_components) continue;\n\n\t\t\tfor (const addr of response.address_components) {\n\t\t\t\tif (addr.types && addr.types[0] === 'postal_code' && addr.short_name) {\n\t\t\t\t\treturn addr.short_name;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn '';\n\t}\n\n\t/**\n\t * Get GB country (England, Scotland, Wales, Northern Ireland)\n\t */\n\tstatic getGBCountry(components) {\n\t\tconst gbCountries = ['England', 'Northern Ireland', 'Scotland', 'Wales'];\n\t\tconst adminArea = components.administrative_area_level_1.long_name || '';\n\n\t\tfor (const country of gbCountries) {\n\t\t\tif (gbCountries.includes(adminArea)) {\n\t\t\t\treturn adminArea;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Check if GB split is enabled (from WordPress filter)\n\t */\n\tstatic isGBSplitEnabled() {\n\t\t// This would be set by PHP via inline script\n\t\treturn window.geodir_split_uk === true;\n\t}\n}\n","/**\n * Geocoding - Utilities for geocoding and reverse geocoding\n *\n * Provides a unified interface for geocoding operations using the map provider.\n */\nimport { CountryRules } from './CountryRules.js';\n\nexport class Geocoding {\n\t/**\n\t * Constructor\n\t * @param {MapProvider} mapProvider - The map provider instance\n\t */\n\tconstructor(mapProvider) {\n\t\tthis.mapProvider = mapProvider;\n\t}\n\n\t/**\n\t * Geocode an address to coordinates\n\t *\n\t * @param {string} address - Full address string\n\t * @param {string} countryISO - Optional country ISO code to restrict search\n\t * @returns {Promise<Object>} Geocoded result with lat, lng, and parsed address\n\t */\n\tasync geocodeAddress(address, countryISO = '') {\n\t\ttry {\n\t\t\tconst request = countryISO\n\t\t\t\t? { address, country: countryISO }\n\t\t\t\t: address;\n\n\t\t\tconst results = await this.mapProvider.geocode(request);\n\n\t\t\tif (!results || results.length === 0) {\n\t\t\t\tthrow new Error('No results found');\n\t\t\t}\n\n\t\t\t// Parse the address components\n\t\t\tconst parsed = CountryRules.parseAddress(results, {\n\t\t\t\tmapType: this.mapProvider.getType()\n\t\t\t});\n\n\t\t\t// For Google Maps\n\t\t\tif (this.mapProvider.getType() === 'google' && results[0].geometry) {\n\t\t\t\tconst location = results[0].geometry.location;\n\t\t\t\treturn {\n\t\t\t\t\tlat: typeof location.lat === 'function' ? location.lat() : location.lat,\n\t\t\t\t\tlng: typeof location.lng === 'function' ? location.lng() : location.lng,\n\t\t\t\t\taddress: parsed,\n\t\t\t\t\trawResults: results\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// For OSM\n\t\t\tif (this.mapProvider.getType() === 'osm') {\n\t\t\t\treturn {\n\t\t\t\t\tlat: results[0].lat,\n\t\t\t\t\tlng: results[0].lon || results[0].lng,\n\t\t\t\t\taddress: parsed,\n\t\t\t\t\trawResults: results\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tthrow new Error('Invalid geocode result format');\n\t\t} catch (error) {\n\t\t\tconsole.error('Geocode error:', error);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Reverse geocode coordinates to an address\n\t *\n\t * @param {number} lat - Latitude\n\t * @param {number} lng - Longitude\n\t * @param {Object} additionalInfo - Additional info from address field (for better results)\n\t * @returns {Promise<Object>} Parsed address components\n\t */\n\tasync reverseGeocode(lat, lng, additionalInfo = {}) {\n\t\ttry {\n\t\t\tconst results = await this.mapProvider.reverseGeocode(lat, lng);\n\n\t\t\tif (!results || results.length === 0) {\n\t\t\t\tthrow new Error('Cannot determine address at this location');\n\t\t\t}\n\n\t\t\t// Parse the address components\n\t\t\tconst parsed = CountryRules.parseAddress(results, {\n\t\t\t\tmapType: this.mapProvider.getType()\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\taddress: parsed,\n\t\t\t\trawResults: results\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tconsole.error('Reverse geocode error:', error);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Build geocode address string from field values\n\t *\n\t * @param {Object} fields - Address field values\n\t * @param {string} fields.street - Street address\n\t * @param {string} fields.city - City\n\t * @param {string} fields.region - Region/state\n\t * @param {string} fields.country - Country\n\t * @param {string} fields.countryISO - Country ISO code\n\t * @param {string} fields.zip - Zip/postal code\n\t * @param {boolean} isRestrict - Whether map is restricted to specific city\n\t * @returns {string} Formatted address string for geocoding\n\t */\n\tstatic buildAddressString(fields, isRestrict = false) {\n\t\tlet address = '';\n\n\t\t// For restricted mode, just use street + zip\n\t\tif (isRestrict && fields.zip && fields.street) {\n\t\t\treturn `${fields.street}, ${fields.zip}`;\n\t\t}\n\n\t\t// Ensure we don't duplicate fields\n\t\tconst street = fields.street || '';\n\t\tconst city = fields.city || '';\n\t\tconst region = fields.region || '';\n\t\tconst country = fields.country || '';\n\t\tconst zip = fields.zip || '';\n\n\t\t// Don't include street if it matches other fields\n\t\tif (street && street !== city && street !== region && street !== country && street !== zip) {\n\t\t\taddress += street;\n\t\t}\n\n\t\t// UK is special - don't include region\n\t\tif (fields.countryISO === 'GB') {\n\t\t\taddress = Geocoding.appendToAddress(address, city);\n\t\t\taddress = Geocoding.appendToAddress(address, country);\n\t\t} else {\n\t\t\taddress = Geocoding.appendToAddress(address, city);\n\t\t\taddress = Geocoding.appendToAddress(address, region);\n\t\t\taddress = Geocoding.appendToAddress(address, country);\n\t\t}\n\n\t\tif (zip) {\n\t\t\taddress = Geocoding.appendToAddress(address, zip);\n\t\t}\n\n\t\t// Clean up multiple commas\n\t\taddress = address.replace(/,+/g, ',');\n\t\taddress = address.replace(/(^,)|(,$)/g, '').trim();\n\n\t\t// Replace \"null\" values\n\t\taddress = address.replace(/,null,/g, ',');\n\n\t\treturn address;\n\t}\n\n\t/**\n\t * Helper to append address part with comma\n\t */\n\tstatic appendToAddress(address, part) {\n\t\tif (!part || part === 'null') return address;\n\t\treturn address ? `${address}, ${part}` : part;\n\t}\n}\n","/**\n * AddressField - Handles add listing address field and map integration\n *\n * This replaces the ~900 lines of inline JavaScript in map-add-listing.php template.\n * Manages the interactive map for adding/editing listing addresses.\n */\nimport { Geocoding } from './Geocoding.js';\n\nexport class AddressField {\n\t/**\n\t * Constructor\n\t * @param {string} prefix - Field name prefix (e.g., 'address_')\n\t * @param {MapProvider} mapProvider - Map provider instance\n\t * @param {Object} options - Configuration options\n\t */\n\tconstructor(prefix, mapProvider, options = {}) {\n\t\tconsole.log('[AddressField] Constructor called with prefix:', prefix);\n\t\tconsole.log('[AddressField] mapProvider:', mapProvider);\n\t\tconsole.log('[AddressField] options:', options);\n\n\t\tthis.prefix = prefix;\n\t\tthis.mapProvider = mapProvider;\n\t\tthis.options = {\n\t\t\tlat: options.lat || '',\n\t\t\tlng: options.lng || '',\n\t\t\tmapZoom: options.mapZoom || 12,\n\t\t\tdefaultLocation: options.defaultLocation || {},\n\t\t\tisRestrict: options.isRestrict !== false,\n\t\t\tautoChangeFields: options.autoChangeFields !== false,\n\t\t\tautoChangePinMove: options.autoChangePinMove !== false,\n\t\t\tminZoomLevel: options.minZoomLevel || 5,\n\t\t\t...options\n\t\t};\n\n\t\tconsole.log('[AddressField] Merged options:', this.options);\n\n\t\tthis.geocoding = new Geocoding(mapProvider);\n\t\tthis.marker = null;\n\t\tthis.userAddress = false;\n\t\tthis.isGeocoding = false;\n\n\t\t// Set defaults if no lat/lng\n\t\tif (!this.options.lat || !this.options.lng) {\n\t\t\tconsole.log('[AddressField] No lat/lng, using defaults');\n\t\t\tthis.options.lat = this.options.defaultLocation.latitude || '';\n\t\t\tthis.options.lng = this.options.defaultLocation.longitude || '';\n\t\t}\n\n\t\tconsole.log('[AddressField] Final coordinates:', this.options.lat, this.options.lng);\n\n\t\tthis.init();\n\t}\n\n\t/**\n\t * Initialize the address field map\n\t */\n\tasync init() {\n\t\tconsole.log('[AddressField] init() called');\n\n\t\t// Initialize the map\n\t\tconsole.log('[AddressField] Initializing map provider...');\n\t\tconst initialized = this.mapProvider.init();\n\t\tconsole.log('[AddressField] Map provider init result:', initialized);\n\n\t\tif (!initialized) {\n\t\t\tconsole.error('[AddressField] Map initialization failed');\n\t\t\tthis.showMapError();\n\t\t\treturn;\n\t\t}\n\n\t\t// Create the draggable marker\n\t\tconsole.log('[AddressField] Creating marker...');\n\t\tthis.createMarker();\n\n\t\t// Set up event listeners\n\t\tconsole.log('[AddressField] Setting up listeners...');\n\t\tthis.setupAddressListeners();\n\t\tthis.setupMapListeners();\n\t\tthis.setupSetAddressButton();\n\n\t\t// Hide loading indicator\n\t\tconsole.log('[AddressField] Hiding loading indicator');\n\t\tthis.hideLoading();\n\n\t\tconsole.log('[AddressField] Initialization complete!');\n\n\t\t// Set min zoom\n\t\tif (this.options.minZoomLevel > 0) {\n\t\t\tthis.mapProvider.addEventListener('zoom_changed', () => {\n\t\t\t\tif (this.mapProvider.getZoom() < this.options.minZoomLevel) {\n\t\t\t\t\tthis.mapProvider.setZoom(this.options.minZoomLevel);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Create the draggable marker\n\t */\n\tcreateMarker() {\n\t\tconst lat = parseFloat(this.options.lat) || 0;\n\t\tconst lng = parseFloat(this.options.lng) || 0;\n\n\t\t// Get marker icon from settings\n\t\tconst icon = this.options.markerIcon || '';\n\t\tconst iconSize = this.options.markerSize || { w: 20, h: 34 };\n\n\t\tthis.marker = this.mapProvider.createMarker({\n\t\t\tlat,\n\t\t\tlng,\n\t\t\tid: 'baseMarker',\n\t\t\ticon,\n\t\t\tdraggable: true,\n\t\t\tw: iconSize.w,\n\t\t\th: iconSize.h\n\t\t});\n\n\t\t// Set up marker drag listeners\n\t\tthis.setupMarkerListeners();\n\t}\n\n\t/**\n\t * Set up marker event listeners\n\t */\n\tsetupMarkerListeners() {\n\t\tif (!this.marker) return;\n\n\t\t// Marker drag events\n\t\tthis.mapProvider.addMarkerListener(this.marker, 'drag', () => {\n\t\t\tthis.updateMarkerPosition();\n\t\t});\n\n\t\tthis.mapProvider.addMarkerListener(this.marker, 'dragend', () => {\n\t\t\tthis.mapProvider.panTo(\n\t\t\t\tthis.getMarkerLat(),\n\t\t\t\tthis.getMarkerLng()\n\t\t\t);\n\n\t\t\tif (this.options.autoChangePinMove) {\n\t\t\t\tthis.reverseGeocodeMarkerPosition();\n\t\t\t}\n\n\t\t\tthis.updateMarkerPosition();\n\t\t});\n\t}\n\n\t/**\n\t * Set up map event listeners\n\t */\n\tsetupMapListeners() {\n\t\t// Map drag events\n\t\tthis.mapProvider.addEventListener('dragend', () => {\n\t\t\tthis.centerMarker();\n\n\t\t\tif (this.options.autoChangePinMove) {\n\t\t\t\tthis.reverseGeocodeMarkerPosition();\n\t\t\t}\n\n\t\t\tthis.updateMarkerPosition();\n\t\t});\n\n\t\t// Zoom change events\n\t\tthis.mapProvider.addEventListener('zoom_changed', () => {\n\t\t\tthis.updateMapZoom();\n\t\t});\n\t}\n\n\t/**\n\t * Set up address field listeners\n\t */\n\tsetupAddressListeners() {\n\t\tconst streetField = document.getElementById(`${this.prefix}street`);\n\n\t\tif (streetField) {\n\t\t\t// Track when user types in address field\n\t\t\tstreetField.addEventListener('keypress', () => {\n\t\t\t\tthis.userAddress = true;\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Set up \"Set Address on Map\" button\n\t */\n\tsetupSetAddressButton() {\n\t\tconst button = document.getElementById(`${this.prefix}set_address_button`);\n\n\t\tif (button) {\n\t\t\tbutton.addEventListener('click', () => {\n\t\t\t\tthis.codeAddress(true);\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Geocode address from fields and update map\n\t * @param {boolean} setOnMap - Whether this is from \"Set Address on Map\" button\n\t */\n\tasync codeAddress(setOnMap = false) {\n\t\t// Build address string from fields\n\t\tconst address = this.buildAddressFromFields();\n\n\t\tif (!address) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Get country ISO for better results\n\t\tconst countryISO = this.getFieldValue('country', true);\n\n\t\ttry {\n\t\t\tconst result = await this.geocoding.geocodeAddress(address, countryISO);\n\n\t\t\t// Update marker position\n\t\t\tthis.setMarkerPosition(result.lat, result.lng);\n\t\t\tthis.mapProvider.setCenter(result.lat, result.lng);\n\t\t\tthis.updateMarkerPosition();\n\n\t\t\t// Reverse geocode to get full address\n\t\t\tawait this.reverseGeocodeMarkerPosition();\n\n\t\t} catch (error) {\n\t\t\tconsole.error('Geocoding failed:', error);\n\t\t\talert(this.options.txt_geocode_error || 'Geocode was not successful');\n\t\t}\n\t}\n\n\t/**\n\t * Reverse geocode marker position and update fields\n\t */\n\tasync reverseGeocodeMarkerPosition() {\n\t\tif (this.isGeocoding) return;\n\t\tthis.isGeocoding = true;\n\n\t\ttry {\n\t\t\tconst lat = this.getMarkerLat();\n\t\t\tconst lng = this.getMarkerLng();\n\n\t\t\tconst result = await this.geocoding.reverseGeocode(lat, lng);\n\n\t\t\t// Check map restrictions\n\t\t\tif (this.options.isRestrict) {\n\t\t\t\tconst defaultCity = (this.options.defaultLocation.city || '').toLowerCase();\n\t\t\t\tconst geocodedCity = (result.address.city || '').toLowerCase();\n\n\t\t\t\tif (geocodedCity !== defaultCity) {\n\t\t\t\t\talert(this.options.txt_city_restrict || `Please choose any address of the (${defaultCity}) city only.`);\n\t\t\t\t\t// Reset to default location\n\t\t\t\t\tthis.setMarkerPosition(\n\t\t\t\t\t\tthis.options.defaultLocation.latitude,\n\t\t\t\t\t\tthis.options.defaultLocation.longitude\n\t\t\t\t\t);\n\t\t\t\t\tthis.mapProvider.setCenter(\n\t\t\t\t\t\tthis.options.defaultLocation.latitude,\n\t\t\t\t\t\tthis.options.defaultLocation.longitude\n\t\t\t\t\t);\n\t\t\t\t\tthis.updateMarkerPosition();\n\t\t\t\t\tthis.isGeocoding = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Update address fields\n\t\t\tthis.updateAddressFields(result.address);\n\n\t\t} catch (error) {\n\t\t\tconsole.error('Reverse geocoding failed:', error);\n\t\t} finally {\n\t\t\tthis.isGeocoding = false;\n\t\t}\n\t}\n\n\t/**\n\t * Update address fields from geocoded result\n\t */\n\tupdateAddressFields(address) {\n\t\t// Update street (only if user hasn't typed or field is empty)\n\t\tif (!this.userAddress || !this.getFieldValue('street')) {\n\t\t\tthis.setFieldValue('street', address.street);\n\t\t}\n\n\t\t// Update street2\n\t\tif (address.street2) {\n\t\t\tif (!this.userAddress || !this.getFieldValue('street2')) {\n\t\t\t\tthis.setFieldValue('street2', address.street2);\n\t\t\t}\n\t\t}\n\n\t\t// Update zip\n\t\tthis.setFieldValue('zip', address.zip);\n\n\t\t// Update location fields if auto-change is enabled\n\t\tif (this.options.autoChangeFields) {\n\t\t\tif (address.country) {\n\t\t\t\tthis.setCountryValue(address.country, address.countryISO);\n\t\t\t}\n\t\t\tif (address.region) {\n\t\t\t\tthis.setFieldValue('region', address.region);\n\t\t\t}\n\t\t\tif (address.city) {\n\t\t\t\tthis.setFieldValue('city', address.city);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Build address string from field values\n\t */\n\tbuildAddressFromFields() {\n\t\tconst fields = {\n\t\t\tstreet: this.getFieldValue('street'),\n\t\t\tcity: this.getFieldValue('city'),\n\t\t\tregion: this.getFieldValue('region'),\n\t\t\tcountry: this.getFieldValue('country'),\n\t\t\tcountryISO: this.getFieldValue('country', true),\n\t\t\tzip: this.getFieldValue('zip')\n\t\t};\n\n\t\treturn Geocoding.buildAddressString(fields, this.options.isRestrict);\n\t}\n\n\t/**\n\t * Get field value\n\t * @param {string} fieldName - Field name without prefix\n\t * @param {boolean} getData - Get data attribute instead of value\n\t */\n\tgetFieldValue(fieldName, getData = false) {\n\t\tconst field = document.getElementById(`${this.prefix}${fieldName}`);\n\t\tif (!field) return '';\n\n\t\tif (getData) {\n\t\t\t// For country, get ISO code from selected option\n\t\t\tif (fieldName === 'country') {\n\t\t\t\tconst option = field.options[field.selectedIndex];\n\t\t\t\treturn option ? (option.dataset.country_code || '') : '';\n\t\t\t}\n\t\t\treturn field.dataset.value || '';\n\t\t}\n\n\t\treturn field.value || '';\n\t}\n\n\t/**\n\t * Set field value\n\t */\n\tsetFieldValue(fieldName, value) {\n\t\tconst field = document.getElementById(`${this.prefix}${fieldName}`);\n\t\tif (!field || !value) return;\n\n\t\t// For select2 fields\n\t\tif (field.classList.contains('select2-hidden-accessible')) {\n\t\t\tfield.value = value;\n\t\t\t// Trigger change event for Select2\n\t\t\tfield.dispatchEvent(new Event('change', { bubbles: true }));\n\t\t\tfield.dispatchEvent(new CustomEvent('change.select2', { bubbles: true }));\n\t\t} else {\n\t\t\tfield.value = value;\n\t\t}\n\n\t\t// Trigger blur for validation\n\t\tfield.dispatchEvent(new Event('blur', { bubbles: true }));\n\t}\n\n\t/**\n\t * Set country select value (special handling for country dropdown)\n\t */\n\tsetCountryValue(country, countryISO) {\n\t\tconst field = document.getElementById(`${this.prefix}country`);\n\t\tif (!field) return;\n\n\t\t// Try to find by ISO code first\n\t\tlet option = field.querySelector(`option[data-country_code=\"${countryISO}\"]`);\n\n\t\tif (!option) {\n\t\t\t// Try to find by country name\n\t\t\toption = Array.from(field.options).find(opt => opt.value === country);\n\t\t}\n\n\t\tif (option) {\n\t\t\tfield.value = option.value;\n\t\t\tif (field.classList.contains('select2-hidden-accessible')) {\n\t\t\t\tfield.dispatchEvent(new CustomEvent('change.select2', { bubbles: true }));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Update marker position in hidden fields\n\t */\n\tupdateMarkerPosition() {\n\t\tconst latField = document.querySelector(`[name=\"latitude\"]`);\n\t\tconst lngField = document.querySelector(`[name=\"longitude\"]`);\n\n\t\tif (latField) {\n\t\t\tlatField.value = this.getMarkerLat();\n\t\t\tlatField.dispatchEvent(new Event('change', { bubbles: true }));\n\t\t}\n\n\t\tif (lngField) {\n\t\t\tlngField.value = this.getMarkerLng();\n\t\t\tlngField.dispatchEvent(new Event('change', { bubbles: true }));\n\t\t}\n\t}\n\n\t/**\n\t * Update map zoom in hidden field\n\t */\n\tupdateMapZoom() {\n\t\tconst zoomField = document.getElementById(`${this.prefix}mapzoom`);\n\t\tif (zoomField) {\n\t\t\tzoomField.value = this.mapProvider.getZoom();\n\t\t}\n\t}\n\n\t/**\n\t * Center marker on map center\n\t */\n\tcenterMarker() {\n\t\tconst center = this.mapProvider.getCenter();\n\t\tthis.setMarkerPosition(center.lat, center.lng);\n\t}\n\n\t/**\n\t * Get marker latitude\n\t */\n\tgetMarkerLat() {\n\t\tif (!this.marker) return 0;\n\n\t\tif (this.mapProvider.getType() === 'google') {\n\t\t\tconst pos = this.marker.getPosition();\n\t\t\treturn typeof pos.lat === 'function' ? pos.lat() : pos.lat;\n\t\t} else {\n\t\t\tconst latlng = this.marker.getLatLng();\n\t\t\treturn latlng.lat;\n\t\t}\n\t}\n\n\t/**\n\t * Get marker longitude\n\t */\n\tgetMarkerLng() {\n\t\tif (!this.marker) return 0;\n\n\t\tif (this.mapProvider.getType() === 'google') {\n\t\t\tconst pos = this.marker.getPosition();\n\t\t\treturn typeof pos.lng === 'function' ? pos.lng() : pos.lng;\n\t\t} else {\n\t\t\tconst latlng = this.marker.getLatLng();\n\t\t\treturn latlng.lng;\n\t\t}\n\t}\n\n\t/**\n\t * Set marker position\n\t */\n\tsetMarkerPosition(lat, lng) {\n\t\tif (!this.marker) return;\n\n\t\tif (this.mapProvider.getType() === 'google') {\n\t\t\tthis.marker.setPosition(new google.maps.LatLng(lat, lng));\n\t\t} else {\n\t\t\tthis.marker.setLatLng(new L.LatLng(lat, lng));\n\t\t}\n\t}\n\n\t/**\n\t * Hide loading indicator\n\t */\n\thideLoading() {\n\t\tconst loadingDiv = document.getElementById(`${this.prefix}map_loading_div`);\n\t\tif (loadingDiv) {\n\t\t\tloadingDiv.style.display = 'none';\n\t\t}\n\t}\n\n\t/**\n\t * Show map error\n\t */\n\tshowMapError() {\n\t\tconst loadingDiv = document.getElementById(`${this.prefix}map_loading_div`);\n\t\tconst notFoundDiv = document.getElementById(`${this.prefix}map_nofound`);\n\t\tconst notLoadedDiv = document.getElementById(`${this.prefix}map_notloaded`);\n\n\t\tif (loadingDiv) loadingDiv.style.display = 'none';\n\t\tif (notFoundDiv) notFoundDiv.style.display = 'none';\n\t\tif (notLoadedDiv) notLoadedDiv.style.display = 'block';\n\t}\n}\n","/**\n * GeoDirectory Maps\n *\n * Modern modular map system for GeoDirectory.\n * Supports Google Maps and OpenStreetMap (Leaflet).\n */\n\n// Core classes\nimport { MapProvider } from './core/MapProvider.js';\nimport { GoogleMapProvider } from './core/GoogleMapProvider.js';\nimport { OSMMapProvider } from './core/OSMMapProvider.js';\nimport { MapFactory } from './core/MapFactory.js';\n\n// Features\nimport { Geocoding } from './features/Geocoding.js';\nimport { CountryRules } from './features/CountryRules.js';\nimport { AddressField } from './features/AddressField.js';\n\n// Export everything under GeoDir.Maps namespace\nconst Maps = {\n\t// Core\n\tMapProvider,\n\tGoogleMapProvider,\n\tOSMMapProvider,\n\tMapFactory,\n\n\t// Features\n\tGeocoding,\n\tCountryRules,\n\tAddressField,\n\n\t// Convenience methods\n\tcreateMap(elementId, options = {}) {\n\t\tconst provider = MapFactory.create(elementId, options);\n\t\tif (provider) {\n\t\t\tprovider.init();\n\t\t}\n\t\treturn provider;\n\t},\n\n\tgetAvailableProvider() {\n\t\treturn MapFactory.getAvailableProvider();\n\t},\n\n\tisGoogleAvailable() {\n\t\treturn MapFactory.isGoogleMapsAvailable();\n\t},\n\n\tisOSMAvailable() {\n\t\treturn MapFactory.isOSMAvailable();\n\t}\n};\n\n// Attach to window for global access\nwindow.GeoDir = window.GeoDir || {};\nwindow.GeoDir.Maps = Maps;\n\nconsole.log('[GeoDir Maps] Module loaded and attached to window.GeoDir.Maps');\nconsole.log('[GeoDir Maps] Available classes:', Object.keys(Maps));\n\n// Also export for ES6 module usage\nexport default Maps;\nexport {\n\tMapProvider,\n\tGoogleMapProvider,\n\tOSMMapProvider,\n\tMapFactory,\n\tGeocoding,\n\tCountryRules,\n\tAddressField\n};\n"],"names":["MapProvider","elementId","options","lat","lng","zoom","request","event","callback","GoogleMapProvider","mapElement","mapTypeId","markerOptions","iconOptions","marker","center","resolve","reject","geocodeRequest","results","status","googleEvent","OSMMapProvider","address","countryCode","params","result","error","osmResult","state","gbCountries","country","leafletEvent","MapFactory","provider","CountryRules","responses","parsed","components","streetParts","gbCountry","response","addr","type","types","firstResult","street","street2","formatted","addressArray","checks","check","value","parts","countryISO","region","city","zip","adminArea","Geocoding","mapProvider","location","additionalInfo","fields","isRestrict","part","AddressField","prefix","initialized","icon","iconSize","streetField","button","setOnMap","defaultCity","fieldName","getData","field","option","opt","latField","lngField","zoomField","pos","loadingDiv","notFoundDiv","notLoadedDiv","Maps"],"mappings":"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"}