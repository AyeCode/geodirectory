function m(n){n=g(n);const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};return String(n).replace(/[&<>"'`=\/]/g,t=>e[t])}function g(n){if(!n)return n;const e={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#x2F;":"/","&#x60;":"`","&#x3D;":"="};for(const t in e){const i=new RegExp(t,"g");n=n.replace(i,e[t])}return n}function u(n){let e=n.substring(n.lastIndexOf(".")+1);return e=e.split("?").shift(),e&&(e=e.toLowerCase()),e}function S(n){const e=n.lastIndexOf("/")+1,t=n.lastIndexOf(".");return t<e?"":n.substring(e,t)}function b(n){return{pdf:"fa-file-pdf",zip:"fa-file-archive",tar:"fa-file-archive",doc:"fa-file-word",docx:"fa-file-word",odt:"fa-file-word",txt:"fa-file",text:"fa-file",csv:"fa-file-excel",ods:"fa-file-excel",ots:"fa-file-excel",xls:"fa-file-excel",xlsx:"fa-file-excel",avi:"fa-file-video",mp4:"fa-file-video",mov:"fa-file-video",mp3:"fa-file-audio",wav:"fa-file-audio"}[n]||"fa-file"}function M(n){return["jpg","jpe","jpeg","png","gif","bmp","ico","webp","avif","svg"].includes(n)}function p(n){if(n===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],i=Math.floor(Math.log(n)/Math.log(e));return Math.round(n/Math.pow(e,i)*100)/100+" "+t[i]}function h(n){return!n||n==="null"?[]:n.split("::").filter(t=>t&&t!=="null").map((t,i)=>{const o=t.split("|");return{url:o[0]||"",id:o[1]||"",title:g(o[2]||""),caption:g(o[3]||""),index:i}})}function y(n){return n.map(e=>`${e.url}|${e.id}|${m(e.title)}|${m(e.caption)}`).join("::")}function x(n,e){const t=document.getElementById(n);if(!t)return;const i=t.value,o=h(i);if(!o[e])return;const a=o[e],l=m(a.title),d=m(a.caption),s=document.getElementById(`gd_image_meta_${n}`);if(!s){console.error(`Modal #gd_image_meta_${n} not found`);return}const r=window.geodir_params?.label_title||"Title",c=window.geodir_params?.label_caption||"Caption",L=window.geodir_params?.button_set||"Set",$=`
		<div class="form-group mb-3">
			<label for="gd-image-meta-title" class="text-left text-start form-label">${r}</label>
			<input id="gd-image-meta-title" value="${l}" class="form-control">
		</div>
		<div class="form-group mb-3">
			<label for="gd-image-meta-caption" class="text-left text-start form-label">${c}</label>
			<input id="gd-image-meta-caption" value="${d}" class="form-control">
		</div>
	`,B=`
		<button type="button" class="btn btn-primary" data-gd-save-meta data-input-id="${n}" data-order-id="${e}">
			${L}
		</button>
	`,I=s.querySelector(".modal-body"),v=s.querySelector(".modal-footer");I&&(I.innerHTML=$),v&&(v.innerHTML=B);const w=s.querySelector("[data-gd-save-meta]");w&&w.addEventListener("click",function(){E(n,e)},{once:!0}),new bootstrap.Modal(s).show()}function E(n,e){const t=document.getElementById(n);if(!t)return;const i=document.getElementById(`gd_image_meta_${n}`);if(!i)return;const o=i.querySelector("#gd-image-meta-title"),a=i.querySelector("#gd-image-meta-caption");if(!o||!a)return;const l=m(o.value),d=m(a.value),s=h(t.value);if(!s[e])return;s[e].title=l,s[e].caption=d;const r=y(s);t.value=r,t.dispatchEvent(new Event("change",{bubbles:!0}));const c=bootstrap.Modal.getInstance(i);c&&c.hide()}typeof window<"u"&&(window.gd_edit_image_meta=x,window.gd_set_image_meta=E);function F(){if(typeof Alpine>"u"){console.error("Alpine.js is not loaded");return}Alpine.data("gdThumbnails",n=>({images:[],inputId:n,skipNextLoad:!1,sortIteration:0,isImageFile(e){if(!e||typeof e.url!="string")return!1;const t=u(e.url);return M(t)},getFileIcon(e){if(!e||!e.url)return"fa-file";const t=u(e.url);return b(t)},init(){this.loadImages();const e=document.getElementById(this.inputId);e&&e.addEventListener("change",()=>{if(this.skipNextLoad){this.skipNextLoad=!1;return}this.loadImages()}),this.checkImageLimit()},loadImages(){const e=document.getElementById(this.inputId);e&&(this.images=h(e.value))},saveImages(){const e=document.getElementById(this.inputId);if(!e)return;const t=y(this.images);e.value=t,e.dispatchEvent(new Event("change",{bubbles:!0}))},handleSort(e,t){console.log("GD Sort:",e,t);let i=e;if(typeof e=="object"&&e!==null&&typeof e.getAttribute=="function"&&(i=e.getAttribute("data-url")),!i){console.warn("GD Sort: Item identifier missing");return}const a=Alpine.raw(this.images).findIndex(d=>d.url===i);if(a===-1){console.warn("GD Sort: Item not found in data");return}if(a===t)return;this.skipNextLoad=!0;const l=this.images[a];this.images.splice(a,1),this.images.splice(t,0,l),this.sortIteration++,this.saveImages()},removeImage(e){this.images.splice(e,1);const t=document.getElementById(`${this.inputId}totImg`);if(t){const o=parseInt(t.value)||0;t.value=Math.max(0,o-1)}const i=document.getElementById(`${this.inputId}upload-error`);i&&(i.textContent="",i.classList.remove("d-block"),i.classList.add("d-none")),this.saveImages()},editImage(e){x(this.inputId,e)},previewImage(e){const t=this.images[e];if(!t)return;const i=`gd_image_preview_${this.inputId}`;let o=document.getElementById(i);if(!o){const r=`
					<div class="modal bsui fade" id="${i}" tabindex="-1" role="dialog" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered modal-lg">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title"></h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
								</div>
								<div class="modal-body text-center p-0">
								</div>
							</div>
						</div>
					</div>
				`;document.body.insertAdjacentHTML("beforeend",r),o=document.getElementById(i)}const a=o.querySelector(".modal-title"),l=o.querySelector(".modal-body"),d=u(t.url),s=this.isImageFile(t);if(a.textContent=t.title||S(t.url),s)l.innerHTML=`<img src="${t.url}" class="img-fluid" alt="${m(t.title)}" />`;else{const r=b(d);l.innerHTML=`
					<div class="p-5">
						<i class="fas ${r} display-1 mb-3"></i>
						<p><a href="${t.url}" target="_blank" class="btn btn-primary">Open File</a></p>
					</div>
				`}new bootstrap.Modal(o).show()},checkImageLimit(){const e=document.getElementById(`${this.inputId}image_limit`);if(!e)return;const t=parseInt(e.value);if(!(t<=0)){for(;this.images.length>t;)this.images.pop();this.images.length>0&&this.saveImages()}}}))}function f(n){const e=document.getElementById(n);e&&e.dispatchEvent(new Event("change",{bubbles:!0}))}typeof window<"u"&&(window.plu_show_thumbs=f);class T{constructor(e,t){this.container=e,this.imgId=t,this.uploader=null,this.postId=this.getPostId(),this.init()}getPostId(){const e=document.querySelector('#geodirectory-add-post input[name="ID"]');if(e)return e.value;const t=document.querySelector('#post input[name="post_ID"]');return t?t.value:""}init(){if(typeof plupload>"u"){console.error("Plupload library not loaded");return}if(typeof window.geodir_plupload_params>"u"){console.error("geodir_plupload_params not found");return}f(this.imgId);const e=JSON.parse(window.geodir_plupload_params.base_plupload_config);e.browse_button=this.imgId+e.browse_button,e.container=this.imgId+e.container,e.file_data_name=this.imgId+e.file_data_name,document.getElementById(this.imgId+"dropbox")&&(e.drop_element=this.imgId+"dropbox"),e.multipart_params.imgid=this.imgId,e.multipart_params.post_id=this.postId,this.container.classList.contains("plupload-upload-uic-multiple")&&(e.multi_selection=!0);const i=document.getElementById(`${this.imgId}_allowed_types`);let o=i?i.value:"";if(this.imgId==="post_images"&&typeof window.geodir_params<"u"&&window.geodir_params.gd_allowed_img_types&&(o=window.geodir_params.gd_allowed_img_types),o&&o!==""){const a=window.geodir_params?.txt_all_files||"Allowed files";e.filters=[{title:a,extensions:o}]}this.uploader=new plupload.Uploader(e),this.bindEvents(),this.uploader.init()}bindEvents(){this.uploader.bind("Init",(e,t)=>{this.handleInit(e,t)}),this.uploader.bind("UploadFile",(e,t)=>{this.handleUploadFile(e,t)}),this.uploader.bind("UploadComplete",(e,t)=>{this.handleUploadComplete(e,t)}),this.uploader.bind("Error",(e,t)=>{this.handleError(e,t)}),this.uploader.bind("FilesAdded",(e,t)=>{this.handleFilesAdded(e,t)}),this.uploader.bind("UploadProgress",(e,t)=>{this.handleUploadProgress(e,t)}),this.uploader.bind("FileUploaded",(e,t,i)=>{this.handleFileUploaded(e,t,i)})}handleInit(e,t){if(e.features.dragdrop){const o=this.imgId+"dropbox",a=document.getElementById(o);a&&(a.addEventListener("dragenter",()=>{a.classList.add("dragover")}),a.addEventListener("dragleave",()=>{a.classList.remove("dragover")}),a.addEventListener("drop",()=>{a.classList.remove("dragover")}))}const i=this.container.querySelector(".moxie-shim");i&&(i.style.position="initial")}handleUploadFile(e,t){this.imgId==="post_images"&&(window.geodirUploading=!0)}handleUploadComplete(e,t){this.imgId==="post_images"&&(window.geodirUploading=!1)}handleError(e,t){this.imgId==="post_images"&&(window.geodirUploading=!1);const i=document.getElementById(`${this.imgId}upload-error`);if(!i)return;let o="";if(t.code===-600)o=window.geodir_params?.err_max_file_size||"File size error : You tried to upload a file over %s",o=o.replace("%s",window.geodir_plupload_params.upload_img_size);else if(t.code===-601)if(o=window.geodir_params?.err_file_type||"File type error. Allowed file types: %s",this.imgId==="post_images"){const a=document.getElementById(`${this.imgId}_allowed_types`),l=a?a.value:"",d=l!==""?"."+l.replace(/,/g,", ."):"*";o=o.replace("%s",d)}else{const a=document.getElementById(`${this.imgId}_allowed_types`),l=a?a.dataset.exts:"";o=o.replace("%s",l)}else o=t.message;i.classList.remove("d-none"),i.classList.add("d-block"),i.textContent=o}handleFilesAdded(e,t){const i=document.getElementById(`${this.imgId}totImg`),o=document.getElementById(`${this.imgId}image_limit`),a=i?parseInt(i.value):0,l=o?parseInt(o.value):0,d=document.getElementById(`${this.imgId}upload-error`);if(d&&(d.textContent="",d.classList.remove("d-block"),d.classList.add("d-none")),l&&this.container.classList.contains("plupload-upload-uic-multiple")&&l>0){if(a>=l){for(;e.files.length>0;)e.removeFile(e.files[0]);let r=window.geodir_params?.err_file_upload_limit||"You have reached your upload limit of %s files.";return r=r.replace("%s",l),d&&(d.classList.remove("d-none"),d.classList.add("d-block"),d.textContent=r),!1}if(e.files.length>l){for(;e.files.length>0;)e.removeFile(e.files[0]);let r=window.geodir_params?.err_pkg_upload_limit||"You may only upload %s files with this package, please try again.";return r=r.replace("%s",l),d&&(d.classList.remove("d-none"),d.classList.add("d-block"),d.textContent=r),!1}}const s=this.container.querySelector(".filelist");s&&t.forEach(r=>{const c=document.createElement("div");c.className="file",c.id=r.id,c.innerHTML=`
					<b>${r.name}</b>
					(<span>${p(0)}</span>/${p(r.size)})
					<div class="progress">
						<div class="fileprogress progress-bar progress-bar-striped progress-bar-animated"
							 role="progressbar"
							 aria-valuenow="0"
							 aria-valuemin="0"
							 aria-valuemax="100"></div>
					</div>
				`,s.appendChild(c)}),e.refresh(),e.start()}handleUploadProgress(e,t){const i=document.getElementById(t.id);if(!i)return;const o=i.querySelector(".fileprogress"),a=i.querySelector("span");o&&(o.style.width=t.percent+"%"),a&&(a.textContent=p(parseInt(t.size*t.percent/100)))}handleFileUploaded(e,t,i){const o=document.getElementById(t.id);if(o){const s=o.querySelector(".fileprogress");s&&s.classList.remove("progress-bar-animated"),setTimeout(()=>{o.style.opacity="0",setTimeout(()=>o.remove(),300)},500)}let a=i.response;try{const s=JSON.parse(a);s.success&&s.data&&(a=`${s.data.url}|${s.data.id}||`)}catch{}const l=document.getElementById(this.imgId);if(!l)return;const d=document.getElementById(`${this.imgId}totImg`);if(this.container.classList.contains("plupload-upload-uic-multiple")){let s=l.value.trim();s?s+="::"+a:s=a,l.value=s,d&&(d.value=parseInt(d.value)+1)}else l.value=a;l.dispatchEvent(new Event("change",{bubbles:!0})),f(this.imgId)}}document.addEventListener("alpine:init",()=>{F()});function _(){const n=document.querySelectorAll(".plupload-upload-uic");n.length!==0&&n.forEach(e=>{const t=e.getAttribute("id");if(!t){console.warn("Plupload container missing ID",e);return}const i=t.replace("plupload-upload-ui","");if(!i){console.warn("Could not extract image ID from container",e);return}new T(e,i)})}function C(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",_):_()}C();typeof window<"u"&&!window.hasOwnProperty("elementExists")&&(window.elementExists=function(n){return document.querySelector(n)!==null});
//# sourceMappingURL=geodir-plupload.js.map
