function m(n){n=y(n);const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};return String(n).replace(/[&<>"'`=\/]/g,t=>e[t])}function y(n){if(!n)return n;const e={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#x2F;":"/","&#x60;":"`","&#x3D;":"="};for(const t in e){const i=new RegExp(t,"g");n=n.replace(i,e[t])}return n}function g(n){let e=n.substring(n.lastIndexOf(".")+1);return e=e.split("?").shift(),e&&(e=e.toLowerCase()),e}function $(n){const e=n.lastIndexOf("/")+1,t=n.lastIndexOf(".");return t<e?"":n.substring(e,t)}function v(n){return{pdf:"fa-file-pdf",zip:"fa-file-archive",tar:"fa-file-archive",doc:"fa-file-word",docx:"fa-file-word",odt:"fa-file-word",txt:"fa-file",text:"fa-file",csv:"fa-file-excel",ods:"fa-file-excel",ots:"fa-file-excel",xls:"fa-file-excel",xlsx:"fa-file-excel",avi:"fa-file-video",mp4:"fa-file-video",mov:"fa-file-video",mp3:"fa-file-audio",wav:"fa-file-audio"}[n]||"fa-file"}function I(n){return["jpg","jpe","jpeg","png","gif","bmp","ico","webp","avif","svg"].includes(n)}function w(n){if(n===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],i=Math.floor(Math.log(n)/Math.log(e));return Math.round(n/Math.pow(e,i)*100)/100+" "+t[i]}function x(n){return!n||n==="null"?[]:n.split("::").filter(t=>t&&t!=="null").map((t,i)=>{const a=t.split("|");return{url:a[0]||"",id:a[1]||"",title:y(a[2]||""),caption:y(a[3]||""),index:i}})}function B(n){return n.map(e=>`${e.url}|${e.id}|${m(e.title)}|${m(e.caption)}`).join("::")}function M(n,e){const t=document.getElementById(n);if(!t)return;const i=t.value,a=x(i);if(!a[e])return;const o=a[e],l=m(o.title),d=m(o.caption),s=document.getElementById(`gd_image_meta_${n}`);if(!s){console.error(`Modal #gd_image_meta_${n} not found`);return}const r=window.geodir_params?.label_title||"Title",c=window.geodir_params?.label_caption||"Caption",f=window.geodir_params?.button_set||"Set",h=`
		<div class="form-group mb-3">
			<label for="gd-image-meta-title" class="text-left text-start form-label">${r}</label>
			<input id="gd-image-meta-title" value="${l}" class="form-control">
		</div>
		<div class="form-group mb-3">
			<label for="gd-image-meta-caption" class="text-left text-start form-label">${c}</label>
			<input id="gd-image-meta-caption" value="${d}" class="form-control">
		</div>
	`,b=`
		<button type="button" class="btn btn-primary" data-gd-save-meta data-input-id="${n}" data-order-id="${e}">
			${f}
		</button>
	`,u=s.querySelector(".modal-body"),p=s.querySelector(".modal-footer");u&&(u.innerHTML=h),p&&(p.innerHTML=b);const E=s.querySelector("[data-gd-save-meta]");E&&E.addEventListener("click",function(){S(n,e)},{once:!0}),new bootstrap.Modal(s).show()}function S(n,e){const t=document.getElementById(n);if(!t)return;const i=document.getElementById(`gd_image_meta_${n}`);if(!i)return;const a=i.querySelector("#gd-image-meta-title"),o=i.querySelector("#gd-image-meta-caption");if(!a||!o)return;const l=m(a.value),d=m(o.value),s=x(t.value);if(!s[e])return;s[e].title=l,s[e].caption=d;const r=B(s);t.value=r,t.dispatchEvent(new Event("change",{bubbles:!0}));const c=bootstrap.Modal.getInstance(i);c&&c.hide()}typeof window<"u"&&(window.gd_edit_image_meta=M,window.gd_set_image_meta=S);function T(){if(typeof Alpine>"u"){console.error("Alpine.js is not loaded");return}Alpine.data("gdThumbnails",n=>({images:[],inputId:n,skipNextLoad:!1,isImageFile(e){const t=g(e.url);return I(t)},getFileIcon(e){const t=g(e.url);return v(t)},init(){this.loadImages();const e=document.getElementById(this.inputId);e&&e.addEventListener("change",()=>{if(this.skipNextLoad){this.skipNextLoad=!1;return}this.loadImages()}),this.checkImageLimit()},loadImages(){const e=document.getElementById(this.inputId);e&&(this.images=x(e.value))},saveImages(){const e=document.getElementById(this.inputId);if(!e)return;const t=B(this.images);e.value=t,e.dispatchEvent(new Event("change",{bubbles:!0}))},handleSort(){const e=document.getElementById(this.inputId+"plupload-thumbs");if(e){const t=Array.from(e.querySelectorAll(".col.px-2.mb-2")),i=[];t.forEach(l=>{const s=l.querySelector("img")?.src||"",r=this.images.find(c=>c.url===s);if(r){const c=`${r.url}|${r.id}|${r.title||""}|${r.caption||""}`;i.push(c)}});const a=i.join("::"),o=document.getElementById(this.inputId);o&&(this.skipNextLoad=!0,o.value=a,o.dispatchEvent(new Event("change",{bubbles:!0})))}},removeImage(e){this.images.splice(e,1);const t=document.getElementById(`${this.inputId}totImg`);if(t){const a=parseInt(t.value)||0;t.value=Math.max(0,a-1)}const i=document.getElementById(`${this.inputId}upload-error`);i&&(i.textContent="",i.classList.remove("d-block"),i.classList.add("d-none")),this.saveImages()},editImage(e){M(this.inputId,e)},previewImage(e){const t=this.images[e];if(!t)return;const i=`gd_image_preview_${this.inputId}`;let a=document.getElementById(i);if(!a){const r=`
					<div class="modal bsui fade" id="${i}" tabindex="-1" role="dialog" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered modal-lg">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title"></h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
								</div>
								<div class="modal-body text-center p-0">
								</div>
							</div>
						</div>
					</div>
				`;document.body.insertAdjacentHTML("beforeend",r),a=document.getElementById(i)}const o=a.querySelector(".modal-title"),l=a.querySelector(".modal-body"),d=g(t.url),s=I(d);if(o.textContent=t.title||$(t.url),s)l.innerHTML=`<img src="${t.url}" class="img-fluid" alt="${m(t.title)}" />`;else{const r=v(d);l.innerHTML=`
					<div class="p-5">
						<i class="fas ${r} display-1 mb-3"></i>
						<p><a href="${t.url}" target="_blank" class="btn btn-primary">Open File</a></p>
					</div>
				`}new bootstrap.Modal(a).show()},getThumbHTML(e,t){const i=g(e.url),a=$(e.url),o=I(i);let l="",d="",s="",r="";const c=m(e.title),f=m(e.caption);if(o)l=`<img class="gd-file-info embed-responsive-item embed-item-cover-xy"
					src="${e.url}"
					alt="${c}"
					data-index="${t}" />`,e.title&&String(e.title).trim()&&(s=`<span class="gd-title-preview badge badge-light ab-top-left text-truncate mw-100 h-auto text-dark w-auto" style="background: #ffffffc7">${c}</span>`),e.caption&&String(e.caption).trim()&&(r=`<span class="gd-caption-preview badge badge-light ab-top-left mt-4 text-truncate mw-100 h-auto text-dark w-auto" style="background: #ffffffc7">${f}</span>`);else{const p=v(i);d="file-thumb",l=`<i title="${a}"
					class="fas ${p} gd-file-info embed-responsive-item embed-item-cover-xy display-1"
					data-index="${t}"
					aria-hidden="true"></i>`}const h=window.geodir_params?.txt_preview||"Preview",b=window.geodir_params?.txt_edit||"Edit",u=window.geodir_params?.txt_delete||"Delete";return`
				<div class="col px-2 mb-2">
					<div class="thumb ${d} ratio ratio-16x9 embed-responsive embed-responsive-16by9 bg-white border c-move">
						${s}
						${l}
						${r}
						<div class="gd-thumb-actions position-absolute text-white w-100 d-flex justify-content-around" style="bottom: 0; background: #00000063; top: auto; height: 20px;">
							<a class="thumbpreviewlink text-white" title="${m(h)}" href="${e.url}" target="_blank">
								<i class="far fa-eye" aria-hidden="true"></i>
							</a>
							<span class="thumbeditlink c-pointer" title="${m(b)}" @click="editImage(${t})">
								<i class="far fa-edit" aria-hidden="true"></i>
							</span>
							<span class="thumbremovelink c-pointer" title="${m(u)}" @click="removeImage(${t})">
								<i class="fas fa-trash-alt" aria-hidden="true"></i>
							</span>
						</div>
					</div>
				</div>
			`},checkImageLimit(){const e=document.getElementById(`${this.inputId}image_limit`);if(!e)return;const t=parseInt(e.value);if(!(t<=0)){for(;this.images.length>t;)this.images.pop();this.images.length>0&&this.saveImages()}}}))}function _(n){const e=document.getElementById(n);e&&e.dispatchEvent(new Event("change",{bubbles:!0}))}typeof window<"u"&&(window.plu_show_thumbs=_);class k{constructor(e,t){this.container=e,this.imgId=t,this.uploader=null,this.postId=this.getPostId(),this.init()}getPostId(){const e=document.querySelector('#geodirectory-add-post input[name="ID"]');if(e)return e.value;const t=document.querySelector('#post input[name="post_ID"]');return t?t.value:""}init(){if(typeof plupload>"u"){console.error("Plupload library not loaded");return}if(typeof window.geodir_plupload_params>"u"){console.error("geodir_plupload_params not found");return}_(this.imgId);const e=JSON.parse(window.geodir_plupload_params.base_plupload_config);e.browse_button=this.imgId+e.browse_button,e.container=this.imgId+e.container,e.file_data_name=this.imgId+e.file_data_name,document.getElementById(this.imgId+"dropbox")&&(e.drop_element=this.imgId+"dropbox"),e.multipart_params.imgid=this.imgId,e.multipart_params.post_id=this.postId,this.container.classList.contains("plupload-upload-uic-multiple")&&(e.multi_selection=!0);const i=document.getElementById(`${this.imgId}_allowed_types`);let a=i?i.value:"";if(this.imgId==="post_images"&&typeof window.geodir_params<"u"&&window.geodir_params.gd_allowed_img_types&&(a=window.geodir_params.gd_allowed_img_types),a&&a!==""){const o=window.geodir_params?.txt_all_files||"Allowed files";e.filters=[{title:o,extensions:a}]}this.uploader=new plupload.Uploader(e),this.bindEvents(),this.uploader.init()}bindEvents(){this.uploader.bind("Init",(e,t)=>{this.handleInit(e,t)}),this.uploader.bind("UploadFile",(e,t)=>{this.handleUploadFile(e,t)}),this.uploader.bind("UploadComplete",(e,t)=>{this.handleUploadComplete(e,t)}),this.uploader.bind("Error",(e,t)=>{this.handleError(e,t)}),this.uploader.bind("FilesAdded",(e,t)=>{this.handleFilesAdded(e,t)}),this.uploader.bind("UploadProgress",(e,t)=>{this.handleUploadProgress(e,t)}),this.uploader.bind("FileUploaded",(e,t,i)=>{this.handleFileUploaded(e,t,i)})}handleInit(e,t){if(e.features.dragdrop){const a=this.imgId+"dropbox",o=document.getElementById(a);o&&(o.addEventListener("dragenter",()=>{o.classList.add("dragover")}),o.addEventListener("dragleave",()=>{o.classList.remove("dragover")}),o.addEventListener("drop",()=>{o.classList.remove("dragover")}))}const i=this.container.querySelector(".moxie-shim");i&&(i.style.position="initial")}handleUploadFile(e,t){this.imgId==="post_images"&&(window.geodirUploading=!0)}handleUploadComplete(e,t){this.imgId==="post_images"&&(window.geodirUploading=!1)}handleError(e,t){this.imgId==="post_images"&&(window.geodirUploading=!1);const i=document.getElementById(`${this.imgId}upload-error`);if(!i)return;let a="";if(t.code===-600)a=window.geodir_params?.err_max_file_size||"File size error : You tried to upload a file over %s",a=a.replace("%s",window.geodir_plupload_params.upload_img_size);else if(t.code===-601)if(a=window.geodir_params?.err_file_type||"File type error. Allowed file types: %s",this.imgId==="post_images"){const o=document.getElementById(`${this.imgId}_allowed_types`),l=o?o.value:"",d=l!==""?"."+l.replace(/,/g,", ."):"*";a=a.replace("%s",d)}else{const o=document.getElementById(`${this.imgId}_allowed_types`),l=o?o.dataset.exts:"";a=a.replace("%s",l)}else a=t.message;i.classList.remove("d-none"),i.classList.add("d-block"),i.textContent=a}handleFilesAdded(e,t){const i=document.getElementById(`${this.imgId}totImg`),a=document.getElementById(`${this.imgId}image_limit`),o=i?parseInt(i.value):0,l=a?parseInt(a.value):0,d=document.getElementById(`${this.imgId}upload-error`);if(d&&(d.textContent="",d.classList.remove("d-block"),d.classList.add("d-none")),l&&this.container.classList.contains("plupload-upload-uic-multiple")&&l>0){if(o>=l){for(;e.files.length>0;)e.removeFile(e.files[0]);let r=window.geodir_params?.err_file_upload_limit||"You have reached your upload limit of %s files.";return r=r.replace("%s",l),d&&(d.classList.remove("d-none"),d.classList.add("d-block"),d.textContent=r),!1}if(e.files.length>l){for(;e.files.length>0;)e.removeFile(e.files[0]);let r=window.geodir_params?.err_pkg_upload_limit||"You may only upload %s files with this package, please try again.";return r=r.replace("%s",l),d&&(d.classList.remove("d-none"),d.classList.add("d-block"),d.textContent=r),!1}}const s=this.container.querySelector(".filelist");s&&t.forEach(r=>{const c=document.createElement("div");c.className="file",c.id=r.id,c.innerHTML=`
					<b>${r.name}</b>
					(<span>${w(0)}</span>/${w(r.size)})
					<div class="progress">
						<div class="fileprogress progress-bar progress-bar-striped progress-bar-animated"
							 role="progressbar"
							 aria-valuenow="0"
							 aria-valuemin="0"
							 aria-valuemax="100"></div>
					</div>
				`,s.appendChild(c)}),e.refresh(),e.start()}handleUploadProgress(e,t){const i=document.getElementById(t.id);if(!i)return;const a=i.querySelector(".fileprogress"),o=i.querySelector("span");a&&(a.style.width=t.percent+"%"),o&&(o.textContent=w(parseInt(t.size*t.percent/100)))}handleFileUploaded(e,t,i){const a=document.getElementById(t.id);if(a){const s=a.querySelector(".fileprogress");s&&s.classList.remove("progress-bar-animated"),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>a.remove(),300)},500)}let o=i.response;try{const s=JSON.parse(o);s.success&&s.data&&(o=`${s.data.url}|${s.data.id}||`)}catch{}const l=document.getElementById(this.imgId);if(!l)return;const d=document.getElementById(`${this.imgId}totImg`);if(this.container.classList.contains("plupload-upload-uic-multiple")){let s=l.value.trim();s?s+="::"+o:s=o,l.value=s,d&&(d.value=parseInt(d.value)+1)}else l.value=o;l.dispatchEvent(new Event("change",{bubbles:!0})),_(this.imgId)}}document.addEventListener("alpine:init",()=>{T()});function L(){const n=document.querySelectorAll(".plupload-upload-uic");n.length!==0&&n.forEach(e=>{const t=e.getAttribute("id");if(!t){console.warn("Plupload container missing ID",e);return}const i=t.replace("plupload-upload-ui","");if(!i){console.warn("Could not extract image ID from container",e);return}new k(e,i)})}function C(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L):L()}C();typeof window<"u"&&!window.hasOwnProperty("elementExists")&&(window.elementExists=function(n){return document.querySelector(n)!==null});
//# sourceMappingURL=geodir-plupload.js.map
